{"version":3,"file":"BundlrStorageDriver.cjs","sources":["../../../../src/plugins/bundlrStorage/BundlrStorageDriver.ts"],"sourcesContent":["import type { default as NodeBundlr, WebBundlr } from '@bundlr-network/client';\nimport BigNumber from 'bignumber.js';\nimport {\n  Connection,\n  Keypair,\n  PublicKey,\n  SendOptions,\n  Signer as Web3Signer,\n  Transaction,\n  TransactionSignature,\n} from '@solana/web3.js';\nimport {\n  getBytesFromMetaplexFiles,\n  MetaplexFile,\n  MetaplexFileTag,\n  StorageDriver,\n} from '../storageModule';\nimport { KeypairIdentityDriver } from '../keypairIdentity';\nimport { Metaplex } from '@/Metaplex';\nimport {\n  Amount,\n  IdentitySigner,\n  isIdentitySigner,\n  isKeypairSigner,\n  KeypairSigner,\n  lamports,\n  Signer,\n  toBigNumber,\n} from '@/types';\nimport {\n  AssetUploadFailedError,\n  BundlrWithdrawError,\n  FailedToConnectToBundlrAddressError,\n  FailedToInitializeBundlrError,\n} from '@/errors';\n\n/**\n * This method is necessary to import the Bundlr package on both ESM and CJS modules.\n * Without this, we get a different structure on each module:\n * - CJS: { default: [Getter], WebBundlr: [Getter] }\n * - ESM: { default: { default: [Getter], WebBundlr: [Getter] } }\n * This method fixes this by ensure there is not double default in the imported package.\n */\n// eslint-disable-next-line @typescript-eslint/naming-convention\nfunction _removeDoubleDefault(pkg: any) {\n  if (\n    pkg &&\n    typeof pkg === 'object' &&\n    'default' in pkg &&\n    'default' in pkg.default\n  ) {\n    return pkg.default;\n  }\n\n  return pkg;\n}\n\nexport type BundlrOptions = {\n  address?: string;\n  timeout?: number;\n  providerUrl?: string;\n  priceMultiplier?: number;\n  identity?: Signer;\n};\n\nexport type BundlrWalletAdapter = {\n  publicKey: PublicKey | null;\n  signMessage?: (message: Uint8Array) => Promise<Uint8Array>;\n  signTransaction?: (transaction: Transaction) => Promise<Transaction>;\n  signAllTransactions?: (transactions: Transaction[]) => Promise<Transaction[]>;\n  sendTransaction: (\n    transaction: Transaction,\n    connection: Connection,\n    options?: SendOptions & { signers?: Web3Signer[] }\n  ) => Promise<TransactionSignature>;\n};\n\nexport class BundlrStorageDriver implements StorageDriver {\n  protected _metaplex: Metaplex;\n  protected _bundlr: WebBundlr | NodeBundlr | null = null;\n  protected _options: BundlrOptions;\n\n  constructor(metaplex: Metaplex, options: BundlrOptions = {}) {\n    this._metaplex = metaplex;\n    this._options = {\n      providerUrl: metaplex.connection.rpcEndpoint,\n      ...options,\n    };\n  }\n\n  async getUploadPrice(bytes: number): Promise<Amount> {\n    const bundlr = await this.bundlr();\n    const price = await bundlr.getPrice(bytes);\n\n    return bigNumberToAmount(\n      price.multipliedBy(this._options.priceMultiplier ?? 1.5)\n    );\n  }\n\n  async upload(file: MetaplexFile): Promise<string> {\n    const [uri] = await this.uploadAll([file]);\n\n    return uri;\n  }\n\n  async uploadAll(files: MetaplexFile[]): Promise<string[]> {\n    const bundlr = await this.bundlr();\n    const amount = await this.getUploadPrice(\n      getBytesFromMetaplexFiles(...files)\n    );\n    await this.fund(amount);\n\n    const promises = files.map(async (file) => {\n      const { status, data } = await bundlr.uploader.upload(file.buffer, {\n        tags: getMetaplexFileTagsWithContentType(file),\n      });\n\n      if (status >= 300) {\n        throw new AssetUploadFailedError(status);\n      }\n\n      return `https://arweave.net/${data.id}`;\n    });\n\n    return await Promise.all(promises);\n  }\n\n  async getBalance(): Promise<Amount> {\n    const bundlr = await this.bundlr();\n    const balance = await bundlr.getLoadedBalance();\n\n    return bigNumberToAmount(balance);\n  }\n\n  async fund(amount: Amount, skipBalanceCheck = false): Promise<void> {\n    const bundlr = await this.bundlr();\n    let toFund = amountToBigNumber(amount);\n\n    if (!skipBalanceCheck) {\n      const balance = await bundlr.getLoadedBalance();\n\n      toFund = toFund.isGreaterThan(balance)\n        ? toFund.minus(balance)\n        : new BigNumber(0);\n    }\n\n    if (toFund.isLessThanOrEqualTo(0)) {\n      return;\n    }\n\n    // TODO: Catch errors and wrap in BundlrErrors.\n    await bundlr.fund(toFund);\n  }\n\n  async withdrawAll(): Promise<void> {\n    // TODO(loris): Replace with \"withdrawAll\" when available on Bundlr.\n    const bundlr = await this.bundlr();\n    const balance = await bundlr.getLoadedBalance();\n    const minimumBalance = new BigNumber(5000);\n\n    if (balance.isLessThan(minimumBalance)) {\n      return;\n    }\n\n    const balanceToWithdraw = balance.minus(minimumBalance);\n    await this.withdraw(bigNumberToAmount(balanceToWithdraw));\n  }\n\n  async withdraw(amount: Amount): Promise<void> {\n    const bundlr = await this.bundlr();\n\n    const { status } = await bundlr.withdrawBalance(amountToBigNumber(amount));\n\n    if (status >= 300) {\n      throw new BundlrWithdrawError(status);\n    }\n  }\n\n  async bundlr(): Promise<WebBundlr | NodeBundlr> {\n    if (this._bundlr) {\n      return this._bundlr;\n    }\n\n    return (this._bundlr = await this.initBundlr());\n  }\n\n  async initBundlr(): Promise<WebBundlr | NodeBundlr> {\n    const currency = 'solana';\n    const address = this._options?.address ?? 'https://node1.bundlr.network';\n    const options = {\n      timeout: this._options.timeout,\n      providerUrl: this._options.providerUrl,\n    };\n\n    const identity: Signer =\n      this._options.identity ?? this._metaplex.identity();\n\n    // if in node use node bundlr, else use web bundlr\n    // see: https://github.com/metaplex-foundation/js/issues/202\n    const isNode =\n      typeof window === 'undefined' || window.process?.hasOwnProperty('type');\n    let bundlr;\n    if (isNode && isKeypairSigner(identity))\n      bundlr = await this.initNodeBundlr(address, currency, identity, options);\n    else {\n      let identitySigner: IdentitySigner;\n      if (isIdentitySigner(identity)) identitySigner = identity;\n      else\n        identitySigner = new KeypairIdentityDriver(\n          Keypair.fromSecretKey((identity as KeypairSigner).secretKey)\n        );\n\n      bundlr = await this.initWebBundlr(\n        address,\n        currency,\n        identitySigner,\n        options\n      );\n    }\n\n    try {\n      // Check for valid bundlr node.\n      await bundlr.utils.getBundlerAddress(currency);\n    } catch (error) {\n      throw new FailedToConnectToBundlrAddressError(address, {\n        cause: error as Error,\n      });\n    }\n\n    return bundlr;\n  }\n\n  async initNodeBundlr(\n    address: string,\n    currency: string,\n    keypair: KeypairSigner,\n    options: any\n  ): Promise<NodeBundlr> {\n    const bPackage = _removeDoubleDefault(\n      await import('@bundlr-network/client')\n    );\n    return new bPackage.default(address, currency, keypair.secretKey, options);\n  }\n\n  async initWebBundlr(\n    address: string,\n    currency: string,\n    identity: IdentitySigner,\n    options: any\n  ): Promise<WebBundlr> {\n    const wallet: BundlrWalletAdapter = {\n      publicKey: identity.publicKey,\n      signMessage: (message: Uint8Array) => identity.signMessage(message),\n      signTransaction: (transaction: Transaction) =>\n        identity.signTransaction(transaction),\n      signAllTransactions: (transactions: Transaction[]) =>\n        identity.signAllTransactions(transactions),\n      sendTransaction: (\n        transaction: Transaction,\n        connection: Connection,\n        options: SendOptions & { signers?: Web3Signer[] } = {}\n      ): Promise<TransactionSignature> => {\n        const { signers = [], ...sendOptions } = options;\n\n        return this._metaplex\n          .rpc()\n          .sendTransaction(transaction, sendOptions, [identity, ...signers]);\n      },\n    };\n\n    const bPackage = _removeDoubleDefault(\n      await import('@bundlr-network/client')\n    );\n    const bundlr = new bPackage.WebBundlr(address, currency, wallet, options);\n\n    try {\n      // Try to initiate bundlr.\n      await bundlr.ready();\n    } catch (error) {\n      throw new FailedToInitializeBundlrError({ cause: error as Error });\n    }\n\n    return bundlr;\n  }\n}\n\nexport const isBundlrStorageDriver = (\n  storageDriver: StorageDriver\n): storageDriver is BundlrStorageDriver => {\n  return (\n    'bundlr' in storageDriver &&\n    'getBalance' in storageDriver &&\n    'fund' in storageDriver &&\n    'withdrawAll' in storageDriver\n  );\n};\n\nconst bigNumberToAmount = (bigNumber: BigNumber): Amount => {\n  return lamports(toBigNumber(bigNumber.decimalPlaces(0).toString()));\n};\n\nconst amountToBigNumber = (amount: Amount): BigNumber => {\n  return new BigNumber(amount.basisPoints.toString());\n};\n\nconst getMetaplexFileTagsWithContentType = (\n  file: MetaplexFile\n): MetaplexFileTag[] => {\n  if (!file.contentType) {\n    return file.tags;\n  }\n\n  return [{ name: 'Content-Type', value: file.contentType }, ...file.tags];\n};\n"],"names":["_removeDoubleDefault","pkg","default","BundlrStorageDriver","constructor","metaplex","options","_defineProperty","_metaplex","_options","providerUrl","connection","rpcEndpoint","getUploadPrice","bytes","bundlr","price","getPrice","bigNumberToAmount","multipliedBy","priceMultiplier","upload","file","uri","uploadAll","files","amount","getBytesFromMetaplexFiles","fund","promises","map","status","data","uploader","buffer","tags","getMetaplexFileTagsWithContentType","AssetUploadFailedError","id","Promise","all","getBalance","balance","getLoadedBalance","skipBalanceCheck","toFund","amountToBigNumber","isGreaterThan","minus","BigNumber","isLessThanOrEqualTo","withdrawAll","minimumBalance","isLessThan","balanceToWithdraw","withdraw","withdrawBalance","BundlrWithdrawError","_bundlr","initBundlr","currency","address","timeout","identity","isNode","window","process","hasOwnProperty","isKeypairSigner","initNodeBundlr","identitySigner","isIdentitySigner","KeypairIdentityDriver","Keypair","fromSecretKey","secretKey","initWebBundlr","utils","getBundlerAddress","error","FailedToConnectToBundlrAddressError","cause","keypair","bPackage","wallet","publicKey","signMessage","message","signTransaction","transaction","signAllTransactions","transactions","sendTransaction","signers","sendOptions","rpc","WebBundlr","ready","FailedToInitializeBundlrError","isBundlrStorageDriver","storageDriver","bigNumber","lamports","toBigNumber","decimalPlaces","toString","basisPoints","contentType","name","value"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAoCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACA,SAASA,oBAAT,CAA8BC,GAA9B,EAAwC;AACtC,EAAA,IACEA,GAAG,IACH,OAAOA,GAAP,KAAe,QADf,IAEA,SAAaA,IAAAA,GAFb,IAGA,SAAA,IAAaA,GAAG,CAACC,OAJnB,EAKE;IACA,OAAOD,GAAG,CAACC,OAAX,CAAA;AACD,GAAA;;AAED,EAAA,OAAOD,GAAP,CAAA;AACD,CAAA;;AAsBM,MAAME,mBAAN,CAAmD;AAKxDC,EAAAA,WAAW,CAACC,QAAD,EAAqBC,OAAsB,GAAG,EAA9C,EAAkD;AAAA,IAAAC,wCAAA,CAAA,IAAA,EAAA,SAAA,EAHV,IAGU,CAAA,CAAA;;IAC3D,IAAKC,CAAAA,SAAL,GAAiBH,QAAjB,CAAA;AACA,IAAA,IAAA,CAAKI,QAAL,GAAgB;AACdC,MAAAA,WAAW,EAAEL,QAAQ,CAACM,UAAT,CAAoBC,WADnB;MAEd,GAAGN,OAAAA;KAFL,CAAA;AAID,GAAA;;EAEmB,MAAdO,cAAc,CAACC,KAAD,EAAiC;AACnD,IAAA,MAAMC,MAAM,GAAG,MAAM,IAAA,CAAKA,MAAL,EAArB,CAAA;IACA,MAAMC,KAAK,GAAG,MAAMD,MAAM,CAACE,QAAP,CAAgBH,KAAhB,CAApB,CAAA;AAEA,IAAA,OAAOI,iBAAiB,CACtBF,KAAK,CAACG,YAAN,CAAmB,IAAKV,CAAAA,QAAL,CAAcW,eAAd,IAAiC,GAApD,CADsB,CAAxB,CAAA;AAGD,GAAA;;EAEW,MAANC,MAAM,CAACC,IAAD,EAAsC;IAChD,MAAM,CAACC,GAAD,CAAA,GAAQ,MAAM,IAAA,CAAKC,SAAL,CAAe,CAACF,IAAD,CAAf,CAApB,CAAA;AAEA,IAAA,OAAOC,GAAP,CAAA;AACD,GAAA;;EAEc,MAATC,SAAS,CAACC,KAAD,EAA2C;AACxD,IAAA,MAAMV,MAAM,GAAG,MAAM,IAAA,CAAKA,MAAL,EAArB,CAAA;IACA,MAAMW,MAAM,GAAG,MAAM,IAAKb,CAAAA,cAAL,CACnBc,sCAAyB,CAAC,GAAGF,KAAJ,CADN,CAArB,CAAA;AAGA,IAAA,MAAM,IAAKG,CAAAA,IAAL,CAAUF,MAAV,CAAN,CAAA;IAEA,MAAMG,QAAQ,GAAGJ,KAAK,CAACK,GAAN,CAAU,MAAOR,IAAP,IAAgB;MACzC,MAAM;QAAES,MAAF;AAAUC,QAAAA,IAAAA;OAAS,GAAA,MAAMjB,MAAM,CAACkB,QAAP,CAAgBZ,MAAhB,CAAuBC,IAAI,CAACY,MAA5B,EAAoC;QACjEC,IAAI,EAAEC,kCAAkC,CAACd,IAAD,CAAA;AADyB,OAApC,CAA/B,CAAA;;MAIA,IAAIS,MAAM,IAAI,GAAd,EAAmB;AACjB,QAAA,MAAM,IAAIM,kCAAJ,CAA2BN,MAA3B,CAAN,CAAA;AACD,OAAA;;AAED,MAAA,OAAQ,CAAsBC,oBAAAA,EAAAA,IAAI,CAACM,EAAG,CAAtC,CAAA,CAAA;AACD,KAVgB,CAAjB,CAAA;AAYA,IAAA,OAAO,MAAMC,OAAO,CAACC,GAAR,CAAYX,QAAZ,CAAb,CAAA;AACD,GAAA;;AAEe,EAAA,MAAVY,UAAU,GAAoB;AAClC,IAAA,MAAM1B,MAAM,GAAG,MAAM,IAAA,CAAKA,MAAL,EAArB,CAAA;AACA,IAAA,MAAM2B,OAAO,GAAG,MAAM3B,MAAM,CAAC4B,gBAAP,EAAtB,CAAA;IAEA,OAAOzB,iBAAiB,CAACwB,OAAD,CAAxB,CAAA;AACD,GAAA;;AAES,EAAA,MAAJd,IAAI,CAACF,MAAD,EAAiBkB,gBAAgB,GAAG,KAApC,EAA0D;AAClE,IAAA,MAAM7B,MAAM,GAAG,MAAM,IAAA,CAAKA,MAAL,EAArB,CAAA;AACA,IAAA,IAAI8B,MAAM,GAAGC,iBAAiB,CAACpB,MAAD,CAA9B,CAAA;;IAEA,IAAI,CAACkB,gBAAL,EAAuB;AACrB,MAAA,MAAMF,OAAO,GAAG,MAAM3B,MAAM,CAAC4B,gBAAP,EAAtB,CAAA;AAEAE,MAAAA,MAAM,GAAGA,MAAM,CAACE,aAAP,CAAqBL,OAArB,IACLG,MAAM,CAACG,KAAP,CAAaN,OAAb,CADK,GAEL,IAAIO,6BAAJ,CAAc,CAAd,CAFJ,CAAA;AAGD,KAAA;;AAED,IAAA,IAAIJ,MAAM,CAACK,mBAAP,CAA2B,CAA3B,CAAJ,EAAmC;AACjC,MAAA,OAAA;AACD,KAdiE;;;AAiBlE,IAAA,MAAMnC,MAAM,CAACa,IAAP,CAAYiB,MAAZ,CAAN,CAAA;AACD,GAAA;;AAEgB,EAAA,MAAXM,WAAW,GAAkB;AACjC;AACA,IAAA,MAAMpC,MAAM,GAAG,MAAM,IAAA,CAAKA,MAAL,EAArB,CAAA;AACA,IAAA,MAAM2B,OAAO,GAAG,MAAM3B,MAAM,CAAC4B,gBAAP,EAAtB,CAAA;AACA,IAAA,MAAMS,cAAc,GAAG,IAAIH,6BAAJ,CAAc,IAAd,CAAvB,CAAA;;AAEA,IAAA,IAAIP,OAAO,CAACW,UAAR,CAAmBD,cAAnB,CAAJ,EAAwC;AACtC,MAAA,OAAA;AACD,KAAA;;AAED,IAAA,MAAME,iBAAiB,GAAGZ,OAAO,CAACM,KAAR,CAAcI,cAAd,CAA1B,CAAA;AACA,IAAA,MAAM,KAAKG,QAAL,CAAcrC,iBAAiB,CAACoC,iBAAD,CAA/B,CAAN,CAAA;AACD,GAAA;;EAEa,MAARC,QAAQ,CAAC7B,MAAD,EAAgC;AAC5C,IAAA,MAAMX,MAAM,GAAG,MAAM,IAAA,CAAKA,MAAL,EAArB,CAAA;IAEA,MAAM;AAAEgB,MAAAA,MAAAA;KAAW,GAAA,MAAMhB,MAAM,CAACyC,eAAP,CAAuBV,iBAAiB,CAACpB,MAAD,CAAxC,CAAzB,CAAA;;IAEA,IAAIK,MAAM,IAAI,GAAd,EAAmB;AACjB,MAAA,MAAM,IAAI0B,+BAAJ,CAAwB1B,MAAxB,CAAN,CAAA;AACD,KAAA;AACF,GAAA;;AAEW,EAAA,MAANhB,MAAM,GAAoC;IAC9C,IAAI,IAAA,CAAK2C,OAAT,EAAkB;AAChB,MAAA,OAAO,KAAKA,OAAZ,CAAA;AACD,KAAA;;AAED,IAAA,OAAQ,KAAKA,OAAL,GAAe,MAAM,IAAA,CAAKC,UAAL,EAA7B,CAAA;AACD,GAAA;;AAEe,EAAA,MAAVA,UAAU,GAAoC;IAClD,MAAMC,QAAQ,GAAG,QAAjB,CAAA;AACA,IAAA,MAAMC,OAAO,GAAG,IAAA,CAAKpD,QAAL,EAAeoD,OAAf,IAA0B,8BAA1C,CAAA;AACA,IAAA,MAAMvD,OAAO,GAAG;AACdwD,MAAAA,OAAO,EAAE,IAAA,CAAKrD,QAAL,CAAcqD,OADT;MAEdpD,WAAW,EAAE,IAAKD,CAAAA,QAAL,CAAcC,WAAAA;KAF7B,CAAA;;AAKA,IAAA,MAAMqD,QAAgB,GACpB,IAAKtD,CAAAA,QAAL,CAAcsD,QAAd,IAA0B,IAAA,CAAKvD,SAAL,CAAeuD,QAAf,EAD5B,CARkD;AAYlD;;;AACA,IAAA,MAAMC,MAAM,GACV,OAAOC,MAAP,KAAkB,WAAlB,IAAiCA,MAAM,CAACC,OAAP,EAAgBC,cAAhB,CAA+B,MAA/B,CADnC,CAAA;AAEA,IAAA,IAAIpD,MAAJ,CAAA;IACA,IAAIiD,MAAM,IAAII,sBAAe,CAACL,QAAD,CAA7B,EACEhD,MAAM,GAAG,MAAM,IAAA,CAAKsD,cAAL,CAAoBR,OAApB,EAA6BD,QAA7B,EAAuCG,QAAvC,EAAiDzD,OAAjD,CAAf,CADF,KAEK;AACH,MAAA,IAAIgE,cAAJ,CAAA;MACA,IAAIC,uBAAgB,CAACR,QAAD,CAApB,EAAgCO,cAAc,GAAGP,QAAjB,CAAhC,KAEEO,cAAc,GAAG,IAAIE,2CAAJ,CACfC,eAAO,CAACC,aAAR,CAAuBX,QAAD,CAA4BY,SAAlD,CADe,CAAjB,CAAA;AAIF5D,MAAAA,MAAM,GAAG,MAAM,IAAK6D,CAAAA,aAAL,CACbf,OADa,EAEbD,QAFa,EAGbU,cAHa,EAIbhE,OAJa,CAAf,CAAA;AAMD,KAAA;;IAED,IAAI;AACF;AACA,MAAA,MAAMS,MAAM,CAAC8D,KAAP,CAAaC,iBAAb,CAA+BlB,QAA/B,CAAN,CAAA;KAFF,CAGE,OAAOmB,KAAP,EAAc;AACd,MAAA,MAAM,IAAIC,+CAAJ,CAAwCnB,OAAxC,EAAiD;AACrDoB,QAAAA,KAAK,EAAEF,KAAAA;AAD8C,OAAjD,CAAN,CAAA;AAGD,KAAA;;AAED,IAAA,OAAOhE,MAAP,CAAA;AACD,GAAA;;EAEmB,MAAdsD,cAAc,CAClBR,OADkB,EAElBD,QAFkB,EAGlBsB,OAHkB,EAIlB5E,OAJkB,EAKG;IACrB,MAAM6E,QAAQ,GAAGnF,oBAAoB,CACnC,MAAM,mFAAO,wBAAP,MAD6B,CAArC,CAAA;;AAGA,IAAA,OAAO,IAAImF,QAAQ,CAACjF,OAAb,CAAqB2D,OAArB,EAA8BD,QAA9B,EAAwCsB,OAAO,CAACP,SAAhD,EAA2DrE,OAA3D,CAAP,CAAA;AACD,GAAA;;EAEkB,MAAbsE,aAAa,CACjBf,OADiB,EAEjBD,QAFiB,EAGjBG,QAHiB,EAIjBzD,OAJiB,EAKG;AACpB,IAAA,MAAM8E,MAA2B,GAAG;MAClCC,SAAS,EAAEtB,QAAQ,CAACsB,SADc;MAElCC,WAAW,EAAGC,OAAD,IAAyBxB,QAAQ,CAACuB,WAAT,CAAqBC,OAArB,CAFJ;MAGlCC,eAAe,EAAGC,WAAD,IACf1B,QAAQ,CAACyB,eAAT,CAAyBC,WAAzB,CAJgC;MAKlCC,mBAAmB,EAAGC,YAAD,IACnB5B,QAAQ,CAAC2B,mBAAT,CAA6BC,YAA7B,CANgC;MAOlCC,eAAe,EAAE,CACfH,WADe,EAEf9E,UAFe,EAGfL,OAAiD,GAAG,EAHrC,KAImB;QAClC,MAAM;AAAEuF,UAAAA,OAAO,GAAG,EAAZ;UAAgB,GAAGC,WAAAA;AAAnB,SAAA,GAAmCxF,OAAzC,CAAA;AAEA,QAAA,OAAO,KAAKE,SAAL,CACJuF,GADI,EAAA,CAEJH,eAFI,CAEYH,WAFZ,EAEyBK,WAFzB,EAEsC,CAAC/B,QAAD,EAAW,GAAG8B,OAAd,CAFtC,CAAP,CAAA;AAGD,OAAA;KAjBH,CAAA;;IAoBA,MAAMV,QAAQ,GAAGnF,oBAAoB,CACnC,MAAM,mFAAO,wBAAP,MAD6B,CAArC,CAAA;;AAGA,IAAA,MAAMe,MAAM,GAAG,IAAIoE,QAAQ,CAACa,SAAb,CAAuBnC,OAAvB,EAAgCD,QAAhC,EAA0CwB,MAA1C,EAAkD9E,OAAlD,CAAf,CAAA;;IAEA,IAAI;AACF;MACA,MAAMS,MAAM,CAACkF,KAAP,EAAN,CAAA;KAFF,CAGE,OAAOlB,KAAP,EAAc;MACd,MAAM,IAAImB,yCAAJ,CAAkC;AAAEjB,QAAAA,KAAK,EAAEF,KAAAA;AAAT,OAAlC,CAAN,CAAA;AACD,KAAA;;AAED,IAAA,OAAOhE,MAAP,CAAA;AACD,GAAA;;AA9MuD,CAAA;AAiN7CoF,MAAAA,qBAAqB,GAChCC,aADmC,IAEM;EACzC,OACE,QAAA,IAAYA,aAAZ,IACA,YAAgBA,IAAAA,aADhB,IAEA,MAAUA,IAAAA,aAFV,IAGA,aAAA,IAAiBA,aAJnB,CAAA;AAMD,EATM;;AAWP,MAAMlF,iBAAiB,GAAImF,SAAD,IAAkC;AAC1D,EAAA,OAAOC,eAAQ,CAACC,uBAAW,CAACF,SAAS,CAACG,aAAV,CAAwB,CAAxB,CAAA,CAA2BC,QAA3B,EAAD,CAAZ,CAAf,CAAA;AACD,CAFD,CAAA;;AAIA,MAAM3D,iBAAiB,GAAIpB,MAAD,IAA+B;EACvD,OAAO,IAAIuB,6BAAJ,CAAcvB,MAAM,CAACgF,WAAP,CAAmBD,QAAnB,EAAd,CAAP,CAAA;AACD,CAFD,CAAA;;AAIA,MAAMrE,kCAAkC,GACtCd,IADyC,IAEnB;AACtB,EAAA,IAAI,CAACA,IAAI,CAACqF,WAAV,EAAuB;IACrB,OAAOrF,IAAI,CAACa,IAAZ,CAAA;AACD,GAAA;;AAED,EAAA,OAAO,CAAC;AAAEyE,IAAAA,IAAI,EAAE,cAAR;IAAwBC,KAAK,EAAEvF,IAAI,CAACqF,WAAAA;AAApC,GAAD,EAAoD,GAAGrF,IAAI,CAACa,IAA5D,CAAP,CAAA;AACD,CARD;;;;;"}