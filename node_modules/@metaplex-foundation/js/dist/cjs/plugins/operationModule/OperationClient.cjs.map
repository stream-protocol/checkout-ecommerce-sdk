{"version":3,"file":"OperationClient.cjs","sources":["../../../../src/plugins/operationModule/OperationClient.ts"],"sourcesContent":["import type { Metaplex } from '@/Metaplex';\nimport {\n  OperationConstructor,\n  Operation,\n  KeyOfOperation,\n  InputOfOperation,\n  OutputOfOperation,\n  OperationHandler,\n  OperationOptions,\n  OperationScope,\n} from '@/types';\nimport { Disposable, DisposableScope } from '@/utils';\nimport { OperationHandlerMissingError } from '@/errors';\n\n/**\n * @group Modules\n */\nexport class OperationClient {\n  /**\n   * Maps the name of an operation with its operation handler.\n   * Whilst the types on the Map are relatively loose, we ensure\n   * operations match with their handlers when registering them.\n   */\n  protected operationHandlers: Map<\n    string,\n    OperationHandler<any, any, any, any>\n  > = new Map();\n  constructor(protected readonly metaplex: Metaplex) {}\n\n  register<\n    T extends Operation<K, I, O>,\n    K extends string = KeyOfOperation<T>,\n    I = InputOfOperation<T>,\n    O = OutputOfOperation<T>\n  >(\n    operationConstructor: OperationConstructor<T, K, I, O>,\n    operationHandler: OperationHandler<T, K, I, O>\n  ) {\n    this.operationHandlers.set(operationConstructor.key, operationHandler);\n\n    return this;\n  }\n\n  get<\n    T extends Operation<K, I, O>,\n    K extends string = KeyOfOperation<T>,\n    I = InputOfOperation<T>,\n    O = OutputOfOperation<T>\n  >(operation: T): OperationHandler<T, K, I, O> {\n    const operationHandler = this.operationHandlers.get(operation.key) as\n      | OperationHandler<T, K, I, O>\n      | undefined;\n\n    if (!operationHandler) {\n      throw new OperationHandlerMissingError(operation.key);\n    }\n\n    return operationHandler;\n  }\n\n  async execute<\n    T extends Operation<K, I, O>,\n    K extends string = KeyOfOperation<T>,\n    I = InputOfOperation<T>,\n    O = OutputOfOperation<T>\n  >(operation: T, options: OperationOptions = {}): Promise<O> {\n    const operationHandler = this.get<T, K, I, O>(operation);\n    const signal = options.signal ?? new AbortController().signal;\n\n    return new Disposable(signal).run((scope) =>\n      operationHandler.handle(\n        operation,\n        this.metaplex,\n        this.getOperationScope(options, scope)\n      )\n    );\n  }\n\n  protected getOperationScope(\n    options: OperationOptions,\n    scope: DisposableScope\n  ): OperationScope {\n    if (!!options.commitment && !options.confirmOptions) {\n      options.confirmOptions = { commitment: options.commitment };\n    }\n\n    const payer = options.payer ?? this.metaplex.rpc().getDefaultFeePayer();\n\n    return { ...options, ...scope, payer };\n  }\n}\n"],"names":["OperationClient","constructor","metaplex","_defineProperty","Map","register","operationConstructor","operationHandler","operationHandlers","set","key","get","operation","OperationHandlerMissingError","execute","options","signal","AbortController","Disposable","run","scope","handle","getOperationScope","commitment","confirmOptions","payer","rpc","getDefaultFeePayer"],"mappings":";;;;;;;;AAcA;AACA;AACA;;AACO,MAAMA,eAAN,CAAsB;AAC3B;AACF;AACA;AACA;AACA;EAKEC,WAAW,CAAoBC,QAApB,EAAwC;IAAAC,wCAD/C,CAAA,IAAA,EAAA,mBAAA,EAAA,IAAIC,GAAJ,EAC+C,CAAA,CAAA;;IAAA,IAApBF,CAAAA,QAAoB,GAApBA,QAAoB,CAAA;AAAE,GAAA;;AAErDG,EAAAA,QAAQ,CAMNC,oBANM,EAONC,gBAPM,EAQN;IACA,IAAKC,CAAAA,iBAAL,CAAuBC,GAAvB,CAA2BH,oBAAoB,CAACI,GAAhD,EAAqDH,gBAArD,CAAA,CAAA;AAEA,IAAA,OAAO,IAAP,CAAA;AACD,GAAA;;EAEDI,GAAG,CAKDC,SALC,EAK2C;IAC5C,MAAML,gBAAgB,GAAG,IAAA,CAAKC,iBAAL,CAAuBG,GAAvB,CAA2BC,SAAS,CAACF,GAArC,CAAzB,CAAA;;IAIA,IAAI,CAACH,gBAAL,EAAuB;AACrB,MAAA,MAAM,IAAIM,qCAAJ,CAAiCD,SAAS,CAACF,GAA3C,CAAN,CAAA;AACD,KAAA;;AAED,IAAA,OAAOH,gBAAP,CAAA;AACD,GAAA;;AAEY,EAAA,MAAPO,OAAO,CAKXF,SALW,EAKGG,OAAyB,GAAG,EAL/B,EAK+C;AAC1D,IAAA,MAAMR,gBAAgB,GAAG,IAAA,CAAKI,GAAL,CAAqBC,SAArB,CAAzB,CAAA;IACA,MAAMI,MAAM,GAAGD,OAAO,CAACC,MAAR,IAAkB,IAAIC,eAAJ,EAAA,CAAsBD,MAAvD,CAAA;IAEA,OAAO,IAAIE,qBAAJ,CAAeF,MAAf,CAAA,CAAuBG,GAAvB,CAA4BC,KAAD,IAChCb,gBAAgB,CAACc,MAAjB,CACET,SADF,EAEE,IAAA,CAAKV,QAFP,EAGE,IAAKoB,CAAAA,iBAAL,CAAuBP,OAAvB,EAAgCK,KAAhC,CAHF,CADK,CAAP,CAAA;AAOD,GAAA;;AAESE,EAAAA,iBAAiB,CACzBP,OADyB,EAEzBK,KAFyB,EAGT;IAChB,IAAI,CAAC,CAACL,OAAO,CAACQ,UAAV,IAAwB,CAACR,OAAO,CAACS,cAArC,EAAqD;MACnDT,OAAO,CAACS,cAAR,GAAyB;QAAED,UAAU,EAAER,OAAO,CAACQ,UAAAA;OAA/C,CAAA;AACD,KAAA;;AAED,IAAA,MAAME,KAAK,GAAGV,OAAO,CAACU,KAAR,IAAiB,IAAKvB,CAAAA,QAAL,CAAcwB,GAAd,EAAoBC,CAAAA,kBAApB,EAA/B,CAAA;IAEA,OAAO,EAAE,GAAGZ,OAAL;AAAc,MAAA,GAAGK,KAAjB;AAAwBK,MAAAA,KAAAA;KAA/B,CAAA;AACD,GAAA;;AAxE0B;;;;"}