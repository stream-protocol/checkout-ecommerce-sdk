{"version":3,"file":"cancelListing.cjs","sources":["../../../../../src/plugins/auctionHouseModule/operations/cancelListing.ts"],"sourcesContent":["import {\n  CancelInstructionAccounts,\n  createAuctioneerCancelInstruction,\n  createCancelInstruction,\n  createCancelListingReceiptInstruction,\n} from '@metaplex-foundation/mpl-auction-house';\nimport { SYSVAR_INSTRUCTIONS_PUBKEY } from '@solana/web3.js';\nimport { SendAndConfirmTransactionResponse } from '../../rpcModule';\nimport { AUCTIONEER_PRICE } from '../constants';\nimport { AuctioneerAuthorityRequiredError } from '../errors';\nimport { AuctionHouse, Listing } from '../models';\nimport { TransactionBuilder, TransactionBuilderOptions } from '@/utils';\nimport {\n  isSigner,\n  Operation,\n  OperationHandler,\n  OperationScope,\n  Pda,\n  Signer,\n  useOperation,\n} from '@/types';\nimport type { Metaplex } from '@/Metaplex';\n\n// -----------------\n// Operation\n// -----------------\n\nconst Key = 'CancelListingOperation' as const;\n\n/**\n * Cancels the user's listing in the given auction house.\n *\n * ```ts\n * await metaplex\n *   .auctionHouse()\n *   .cancelListing({ auctionHouse, listing };\n * ```\n *\n * @group Operations\n * @category Constructors\n */\nexport const cancelListingOperation = useOperation<CancelListingOperation>(Key);\n\n/**\n * @group Operations\n * @category Types\n */\nexport type CancelListingOperation = Operation<\n  typeof Key,\n  CancelListingInput,\n  CancelListingOutput\n>;\n\n/**\n * @group Operations\n * @category Inputs\n */\nexport type CancelListingInput = {\n  /** The Auction House in which to cancel Bid. */\n  auctionHouse: Pick<\n    AuctionHouse,\n    'address' | 'authorityAddress' | 'feeAccountAddress' | 'hasAuctioneer'\n  >;\n\n  /**\n   * The Listing to cancel.\n   * We only need a subset of the `Listing` model but we\n   * need enough information regarding its settings to know how\n   * to cancel it.\n   *\n   * This includes, its asset, seller address, price, receipt address etc.\n   */\n  listing: Pick<\n    Listing,\n    | 'asset'\n    | 'price'\n    | 'receiptAddress'\n    | 'sellerAddress'\n    | 'tokens'\n    | 'tradeStateAddress'\n  >;\n\n  /**\n   * The Auctioneer authority key.\n   * It is required when Auction House has Auctioneer enabled.\n   *\n   * @defaultValue No default value.\n   */\n  auctioneerAuthority?: Signer;\n};\n\n/**\n * @group Operations\n * @category Outputs\n */\nexport type CancelListingOutput = {\n  /** The blockchain response from sending and confirming the transaction. */\n  response: SendAndConfirmTransactionResponse;\n};\n\n/**\n * @group Operations\n * @category Handlers\n */\nexport const cancelListingOperationHandler: OperationHandler<CancelListingOperation> =\n  {\n    handle: async (\n      operation: CancelListingOperation,\n      metaplex: Metaplex,\n      scope: OperationScope\n    ) =>\n      cancelListingBuilder(metaplex, operation.input, scope).sendAndConfirm(\n        metaplex,\n        scope.confirmOptions\n      ),\n  };\n\n// -----------------\n// Builder\n// -----------------\n\n/**\n * @group Transaction Builders\n * @category Inputs\n */\nexport type CancelListingBuilderParams = Omit<\n  CancelListingInput,\n  'confirmOptions'\n> & {\n  instructionKey?: string;\n};\n\n/**\n * @group Transaction Builders\n * @category Contexts\n */\nexport type CancelListingBuilderContext = Omit<CancelListingOutput, 'response'>;\n\n/**\n * Cancels the user's listing in the given auction house.\n *\n * ```ts\n * const transactionBuilder = metaplex\n *   .auctionHouse()\n *   .builders()\n *   .cancelListing({ auctionHouse, listing });\n * ```\n *\n * @group Transaction Builders\n * @category Constructors\n */\nexport const cancelListingBuilder = (\n  metaplex: Metaplex,\n  params: CancelListingBuilderParams,\n  options: TransactionBuilderOptions = {}\n): TransactionBuilder<CancelListingBuilderContext> => {\n  const { programs, payer = metaplex.rpc().getDefaultFeePayer() } = options;\n  const { auctionHouse, auctioneerAuthority, listing } = params;\n\n  // Data.\n  const {\n    asset,\n    sellerAddress,\n    receiptAddress,\n    tradeStateAddress,\n    price,\n    tokens,\n  } = listing;\n  const {\n    address: auctionHouseAddress,\n    authorityAddress,\n    feeAccountAddress,\n    hasAuctioneer,\n  } = auctionHouse;\n\n  if (hasAuctioneer && !auctioneerAuthority) {\n    throw new AuctioneerAuthorityRequiredError();\n  }\n\n  const buyerPrice = hasAuctioneer ? AUCTIONEER_PRICE : price.basisPoints;\n\n  const accounts: CancelInstructionAccounts = {\n    wallet: sellerAddress,\n    tokenAccount: asset.token.address,\n    tokenMint: asset.address,\n    authority: authorityAddress,\n    auctionHouse: auctionHouseAddress,\n    auctionHouseFeeAccount: feeAccountAddress,\n    tradeState: tradeStateAddress,\n  };\n\n  // Args.\n  const args = {\n    buyerPrice,\n    tokenSize: tokens.basisPoints,\n  };\n\n  // Cancel Listing Instruction.\n  let cancelListingInstruction = createCancelInstruction(accounts, args);\n  if (auctioneerAuthority) {\n    cancelListingInstruction = createAuctioneerCancelInstruction(\n      {\n        ...accounts,\n        auctioneerAuthority: auctioneerAuthority.publicKey,\n        ahAuctioneerPda: metaplex.auctionHouse().pdas().auctioneer({\n          auctionHouse: auctionHouseAddress,\n          auctioneerAuthority: auctioneerAuthority.publicKey,\n          programs,\n        }),\n      },\n      args\n    );\n  }\n\n  // Signers.\n  const cancelSigners = [auctioneerAuthority].filter(isSigner);\n\n  return (\n    TransactionBuilder.make()\n      .setFeePayer(payer)\n\n      // Cancel Listing.\n      .add({\n        instruction: cancelListingInstruction,\n        signers: cancelSigners,\n        key: params.instructionKey ?? 'cancelListing',\n      })\n\n      // Cancel Listing Receipt.\n      .when(Boolean(receiptAddress), (builder) =>\n        builder.add({\n          instruction: createCancelListingReceiptInstruction({\n            receipt: receiptAddress as Pda,\n            instruction: SYSVAR_INSTRUCTIONS_PUBKEY,\n          }),\n          signers: [],\n          key: 'cancelListingReceipt',\n        })\n      )\n  );\n};\n"],"names":["Key","cancelListingOperation","useOperation","cancelListingOperationHandler","handle","operation","metaplex","scope","cancelListingBuilder","input","sendAndConfirm","confirmOptions","params","options","programs","payer","rpc","getDefaultFeePayer","auctionHouse","auctioneerAuthority","listing","asset","sellerAddress","receiptAddress","tradeStateAddress","price","tokens","address","auctionHouseAddress","authorityAddress","feeAccountAddress","hasAuctioneer","AuctioneerAuthorityRequiredError","buyerPrice","AUCTIONEER_PRICE","basisPoints","accounts","wallet","tokenAccount","token","tokenMint","authority","auctionHouseFeeAccount","tradeState","args","tokenSize","cancelListingInstruction","createCancelInstruction","createAuctioneerCancelInstruction","publicKey","ahAuctioneerPda","pdas","auctioneer","cancelSigners","filter","isSigner","TransactionBuilder","make","setFeePayer","add","instruction","signers","key","instructionKey","when","Boolean","builder","createCancelListingReceiptInstruction","receipt","SYSVAR_INSTRUCTIONS_PUBKEY"],"mappings":"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"}