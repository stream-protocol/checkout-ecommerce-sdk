{"version":3,"file":"allowList.cjs","sources":["../../../../../src/plugins/candyMachineModule/guards/allowList.ts"],"sourcesContent":["import { Buffer } from 'buffer';\nimport * as beet from '@metaplex-foundation/beet';\nimport { AllowList, allowListBeet } from '@metaplex-foundation/mpl-candy-guard';\nimport { CandyGuardManifest } from './core';\nimport { createSerializerFromBeet, mapSerializer } from '@/types';\n\n/**\n * The allowList guard validates the minting wallet against\n * a predefined list of wallets.\n *\n * Instead of passing the entire list of wallets as settings,\n * this guard accepts the Root of a Merkle Tree created from\n * this allow list. The program can then validate that the minting\n * wallet is part of the allow list by requiring a Merkle Proof.\n * Minting will fail if either the minting address is not part of\n * the merkle tree or if no Merkle Proof is specified.\n *\n * You may use the `getMerkleRoot` and `getMerkleProof` helper\n * functions provided by the SDK to help you set up this guard.\n * Here is an example.\n *\n * ```ts\n * import { getMerkleProof, getMerkleRoot } from '@metaplex-foundation/js';\n * const allowList = [\n *   'Ur1CbWSGsXCdedknRbJsEk7urwAvu1uddmQv51nAnXB',\n *   'GjwcWFQYzemBtpUoN5fMAP2FZviTtMRWCmrppGuTthJS',\n *   'AT8nPwujHAD14cLojTcB1qdBzA1VXnT6LVGuUd6Y73Cy',\n * ];\n * const merkleRoot = getMerkleRoot(allowList);\n * const validMerkleProof = getMerkleProof(allowList, 'Ur1CbWSGsXCdedknRbJsEk7urwAvu1uddmQv51nAnXB');\n * const invalidMerkleProof = getMerkleProof(allowList, 'invalid-address');\n * ```\n *\n * Note that you will need to provide the Merkle Proof for the\n * minting wallet before calling the mint instruction via the\n * special \"route\" instruction of the guard.\n * See {@link AllowListGuardRouteSettings} for more information.\n *\n * This object defines the settings that should be\n * provided when creating and/or updating a Candy\n * Machine if you wish to enable this guard.\n *\n * @see {@link AllowListGuardRouteSettings} to learn more about\n * the instructions that can be executed against this guard.\n */\nexport type AllowListGuardSettings = {\n  /**\n   * The Root of the Merkle Tree representing the allow list.\n   * You may use the `getMerkleRoot` helper function to generate this.\n   */\n  merkleRoot: Uint8Array;\n};\n\n/**\n * The settings for the allowList guard that should be provided\n * when accessing the guard's special \"route\" instruction.\n *\n * ## Proof\n * The `proof` path allows you to provide a Merkle Proof\n * for a specific wallet in order to allow minting for that wallet.\n * This will create a small PDA account on the Program as a proof\n * that the wallet has been allowed to mint.\n *\n * ```ts\n * await metaplex.candyMachines().callGuardRoute({\n *   candyMachine,\n *   guard: 'allowList',\n *   settings: {\n *     path: 'proof',\n *     merkleProof: getMerkleProof(allowedWallets, metaplex.identity().publicKey.toBase58()),\n *   },\n * });\n *\n * // You are now allows to mint with this wallet.\n * ```\n *\n * @see {@link AllowListGuardSettings} for more\n * information on the allowList guard itself.\n */\nexport type AllowListGuardRouteSettings = {\n  /** Selects the path to execute in the route instruction. */\n  path: 'proof';\n\n  /**\n   * The Proof that the minting wallet is part of the\n   * Merkle Tree-based allow list. You may use the\n   * `getMerkleProof` helper function to generate this.\n   */\n  merkleProof: Uint8Array[];\n};\n\n/** @internal */\nexport const allowListGuardManifest: CandyGuardManifest<\n  AllowListGuardSettings,\n  {},\n  AllowListGuardRouteSettings\n> = {\n  name: 'allowList',\n  settingsBytes: 32,\n  settingsSerializer: mapSerializer<AllowList, AllowListGuardSettings>(\n    createSerializerFromBeet(allowListBeet),\n    (settings) => ({ merkleRoot: new Uint8Array(settings.merkleRoot) }),\n    (settings) => ({ merkleRoot: Array.from(settings.merkleRoot) })\n  ),\n  mintSettingsParser: ({\n    metaplex,\n    settings,\n    payer,\n    candyMachine,\n    candyGuard,\n  }) => {\n    return {\n      arguments: Buffer.from([]),\n      remainingAccounts: [\n        {\n          isSigner: false,\n          isWritable: false,\n          address: metaplex.candyMachines().pdas().merkleProof({\n            merkleRoot: settings.merkleRoot,\n            user: payer.publicKey,\n            candyMachine,\n            candyGuard,\n          }),\n        },\n      ],\n    };\n  },\n  routeSettingsParser: ({\n    metaplex,\n    settings,\n    routeSettings,\n    programs,\n    candyMachine,\n    candyGuard,\n    payer,\n  }) => {\n    const proof = routeSettings.merkleProof;\n    const vectorSize = Buffer.alloc(4);\n    beet.u32.write(vectorSize, 0, proof.length);\n\n    return {\n      arguments: Buffer.concat([vectorSize, ...proof]),\n      remainingAccounts: [\n        {\n          isSigner: false,\n          isWritable: true,\n          address: metaplex.candyMachines().pdas().merkleProof({\n            merkleRoot: settings.merkleRoot,\n            user: payer.publicKey,\n            candyMachine,\n            candyGuard,\n          }),\n        },\n        {\n          isSigner: false,\n          isWritable: false,\n          address: metaplex.programs().getSystem(programs).address,\n        },\n      ],\n    };\n  },\n};\n"],"names":["allowListGuardManifest","name","settingsBytes","settingsSerializer","mapSerializer","createSerializerFromBeet","allowListBeet","settings","merkleRoot","Uint8Array","Array","from","mintSettingsParser","metaplex","payer","candyMachine","candyGuard","arguments","Buffer","remainingAccounts","isSigner","isWritable","address","candyMachines","pdas","merkleProof","user","publicKey","routeSettingsParser","routeSettings","programs","proof","vectorSize","alloc","beet","u32","write","length","concat","getSystem"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AA+CA;AACO,MAAMA,sBAIZ,GAAG;AACFC,EAAAA,IAAI,EAAE,WADJ;AAEFC,EAAAA,aAAa,EAAE,EAFb;EAGFC,kBAAkB,EAAEC,wBAAa,CAC/BC,mCAAwB,CAACC,2BAAD,CADO,EAE9BC,QAAD,KAAe;AAAEC,IAAAA,UAAU,EAAE,IAAIC,UAAJ,CAAeF,QAAQ,CAACC,UAAxB,CAAA;GAA7B,CAF+B,EAG9BD,QAAD,KAAe;AAAEC,IAAAA,UAAU,EAAEE,KAAK,CAACC,IAAN,CAAWJ,QAAQ,CAACC,UAApB,CAAA;AAAd,GAAf,CAH+B,CAH/B;AAQFI,EAAAA,kBAAkB,EAAE,CAAC;IACnBC,QADmB;IAEnBN,QAFmB;IAGnBO,KAHmB;IAInBC,YAJmB;AAKnBC,IAAAA,UAAAA;AALmB,GAAD,KAMd;IACJ,OAAO;AACLC,MAAAA,SAAS,EAAEC,aAAM,CAACP,IAAP,CAAY,EAAZ,CADN;AAELQ,MAAAA,iBAAiB,EAAE,CACjB;AACEC,QAAAA,QAAQ,EAAE,KADZ;AAEEC,QAAAA,UAAU,EAAE,KAFd;QAGEC,OAAO,EAAET,QAAQ,CAACU,aAAT,GAAyBC,IAAzB,EAAA,CAAgCC,WAAhC,CAA4C;UACnDjB,UAAU,EAAED,QAAQ,CAACC,UAD8B;UAEnDkB,IAAI,EAAEZ,KAAK,CAACa,SAFuC;UAGnDZ,YAHmD;AAInDC,UAAAA,UAAAA;SAJO,CAAA;OAJM,CAAA;KAFrB,CAAA;GAfA;AA+BFY,EAAAA,mBAAmB,EAAE,CAAC;IACpBf,QADoB;IAEpBN,QAFoB;IAGpBsB,aAHoB;IAIpBC,QAJoB;IAKpBf,YALoB;IAMpBC,UANoB;AAOpBF,IAAAA,KAAAA;AAPoB,GAAD,KAQf;AACJ,IAAA,MAAMiB,KAAK,GAAGF,aAAa,CAACJ,WAA5B,CAAA;AACA,IAAA,MAAMO,UAAU,GAAGd,aAAM,CAACe,KAAP,CAAa,CAAb,CAAnB,CAAA;IACAC,eAAI,CAACC,GAAL,CAASC,KAAT,CAAeJ,UAAf,EAA2B,CAA3B,EAA8BD,KAAK,CAACM,MAApC,CAAA,CAAA;IAEA,OAAO;MACLpB,SAAS,EAAEC,aAAM,CAACoB,MAAP,CAAc,CAACN,UAAD,EAAa,GAAGD,KAAhB,CAAd,CADN;AAELZ,MAAAA,iBAAiB,EAAE,CACjB;AACEC,QAAAA,QAAQ,EAAE,KADZ;AAEEC,QAAAA,UAAU,EAAE,IAFd;QAGEC,OAAO,EAAET,QAAQ,CAACU,aAAT,GAAyBC,IAAzB,EAAA,CAAgCC,WAAhC,CAA4C;UACnDjB,UAAU,EAAED,QAAQ,CAACC,UAD8B;UAEnDkB,IAAI,EAAEZ,KAAK,CAACa,SAFuC;UAGnDZ,YAHmD;AAInDC,UAAAA,UAAAA;SAJO,CAAA;AAHX,OADiB,EAWjB;AACEI,QAAAA,QAAQ,EAAE,KADZ;AAEEC,QAAAA,UAAU,EAAE,KAFd;QAGEC,OAAO,EAAET,QAAQ,CAACiB,QAAT,GAAoBS,SAApB,CAA8BT,QAA9B,CAAwCR,CAAAA,OAAAA;OAdlC,CAAA;KAFrB,CAAA;AAoBD,GAAA;AAhEC;;;;"}