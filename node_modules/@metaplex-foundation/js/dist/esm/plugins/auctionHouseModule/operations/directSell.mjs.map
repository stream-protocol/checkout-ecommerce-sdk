{"version":3,"file":"directSell.mjs","sources":["../../../../../src/plugins/auctionHouseModule/operations/directSell.ts"],"sourcesContent":["import { PublicKey } from '@solana/web3.js';\nimport { SendAndConfirmTransactionResponse } from '../../rpcModule';\nimport { Token } from '../../tokenModule';\nimport { AuctioneerAuthorityRequiredError } from '../errors';\nimport {\n  AuctionHouse,\n  isPrivateBid,\n  Listing,\n  PrivateBid,\n  PublicBid,\n  Purchase,\n} from '../models';\nimport { CreateListingBuilderContext } from './createListing';\nimport { ExecuteSaleBuilderContext } from './executeSale';\nimport { TransactionBuilder, TransactionBuilderOptions } from '@/utils';\nimport {\n  now,\n  Operation,\n  OperationHandler,\n  OperationScope,\n  Signer,\n  toPublicKey,\n  useOperation,\n} from '@/types';\nimport type { Metaplex } from '@/Metaplex';\n\n// -----------------\n// Operation\n// -----------------\n\nconst Key = 'DirectSellOperation' as const;\n\n/**\n * Creates a listing on a given asset and then executes a sell on the created bid and listing.\n *\n * ```ts\n * await metaplex\n *   .auctionHouse()\n *   .sell({ auctionHouse, bid };\n * ```\n *\n * @group Operations\n * @category Constructors\n */\nexport const directSellOperation = useOperation<DirectSellOperation>(Key);\n\n/**\n * @group Operations\n * @category Types\n */\nexport type DirectSellOperation = Operation<\n  typeof Key,\n  DirectSellInput,\n  DirectSellOutput\n>;\n\n/**\n * @group Operations\n * @category Inputs\n */\nexport type DirectSellInput = {\n  /** The Auction House in which to create a Listing and execute a Sale. */\n  auctionHouse: AuctionHouse;\n\n  /**\n   * The Auction House authority.\n   * If this is Signer the transaction fee\n   * will be paid from the Auction House Fee Account\n   *\n   * @defaultValue `auctionHouse.authority`\n   */\n  authority?: PublicKey | Signer;\n\n  /**\n   * Creator of a listing.\n   *\n   * There must be one and only one signer; Authority or Seller must sign.\n   *\n   * @defaultValue `metaplex.identity()`\n   */\n  seller?: PublicKey | Signer;\n\n  /**\n   * The Auctioneer authority key.\n   * It is required when Auction House has Auctioneer enabled.\n   *\n   * @defaultValue No default value.\n   */\n  auctioneerAuthority?: Signer;\n\n  /**\n   * The address of the bookkeeper wallet responsible for the receipt.\n   *\n   * @defaultValue `metaplex.identity()`\n   */\n  bookkeeper?: Signer;\n\n  /**\n   * Prints the purchase receipt.\n   * The receipt holds information about the purchase,\n   * So it's important to print it if you want to use the `Purchase` model\n   *\n   * @defaultValue `true`\n   */\n  printReceipt?: boolean;\n} & (\n  | {\n      /**\n       * The Token Account of an asset to sell.\n       * Public Bid doesn't contain a token, so it must be provided externally via this parameter.\n       */\n      sellerToken: Token;\n\n      /**\n       * The Public Bid that is used in the sale.\n       * We only need a subset of the `Bid` model but we\n       * need enough information regarding its settings to know how\n       * to execute the sale.\n       *\n       * This includes its auction house address, buyer, receipt address, etc.\n       */\n      bid: Omit<\n        PublicBid,\n        'bookkeeperAddress' | 'purchaseReceiptAddress' | 'createdAt'\n      >;\n    }\n  | {\n      /**\n       * The Token Account of an asset to sell.\n       * Not needed for private bid.\n       */\n      sellerToken?: null;\n\n      /**\n       * The Private Bid that is used in the sale.\n       * We only need a subset of the `Bid` model but we\n       * need enough information regarding its settings to know how\n       * to execute the sale.\n       *\n       * This includes its asset, auction house address, buyer, receipt address, etc.\n       */\n      bid: Omit<\n        PrivateBid,\n        'bookkeeperAddress' | 'purchaseReceiptAddress' | 'createdAt'\n      >;\n    }\n);\n\n/**\n * @group Operations\n * @category Outputs\n */\nexport type DirectSellOutput = {\n  /** A model that keeps information about the Listing. */\n  listing: Listing;\n\n  /** A model that keeps information about the Purchase. */\n  purchase: Purchase;\n\n  /** The blockchain response from sending and confirming the transaction. */\n  response: SendAndConfirmTransactionResponse;\n};\n\n/**\n * @group Operations\n * @category Handlers\n */\nexport const directSellOperationHandler: OperationHandler<DirectSellOperation> =\n  {\n    handle: async (\n      operation: DirectSellOperation,\n      metaplex: Metaplex,\n      scope: OperationScope\n    ) => {\n      const builder = await directSellBuilder(metaplex, operation.input, scope);\n      scope.throwIfCanceled();\n\n      return builder.sendAndConfirm(metaplex, scope.confirmOptions);\n    },\n  };\n\n// -----------------\n// Builder\n// -----------------\n\n/**\n * @group Transaction Builders\n * @category Inputs\n */\nexport type DirectSellBuilderParams = Omit<\n  DirectSellInput,\n  'confirmOptions'\n> & {\n  createListingInstructionKey?: string;\n  executeSaleInstructionKey?: string;\n};\n\n/**\n * @group Transaction Builders\n * @category Contexts\n */\nexport type DirectSellBuilderContext = Omit<DirectSellOutput, 'response'>;\n\n/**\n * Creates a listing on a given asset and executes a sale on the created listing and given bid.\n *\n *\n * ```ts\n * const transactionBuilder = metaplex\n *   .auctionHouse()\n *   .builders()\n *   .sell({ auctionHouse, bid, seller })\n * ```\n *\n * @group Transaction Builders\n * @category Constructors\n */\nexport const directSellBuilder = async (\n  metaplex: Metaplex,\n  params: DirectSellBuilderParams,\n  options: TransactionBuilderOptions = {}\n): Promise<TransactionBuilder<DirectSellBuilderContext>> => {\n  // Data.\n  const { programs, payer = metaplex.rpc().getDefaultFeePayer() } = options;\n  const {\n    auctionHouse,\n    auctioneerAuthority,\n    bid,\n    seller = metaplex.identity(),\n    authority = auctionHouse.authorityAddress,\n    bookkeeper = metaplex.identity(),\n    createListingInstructionKey,\n    executeSaleInstructionKey,\n  } = params;\n  const { hasAuctioneer } = auctionHouse;\n  const { tokens, price, buyerAddress } = bid;\n\n  const printReceipt =\n    (params.printReceipt ?? true) && Boolean(bid.receiptAddress);\n\n  if (hasAuctioneer && !auctioneerAuthority) {\n    throw new AuctioneerAuthorityRequiredError();\n  }\n\n  const asset = isPrivateBid(bid)\n    ? bid.asset\n    : { ...bid.asset, token: params.sellerToken as Token };\n\n  const listingBuilder: TransactionBuilder<CreateListingBuilderContext> =\n    metaplex.auctionHouse().builders().list(\n      {\n        mintAccount: asset.mint.address,\n        price,\n        auctionHouse,\n        auctioneerAuthority,\n        seller,\n        authority,\n        tokenAccount: asset.token.address,\n        tokens,\n        printReceipt,\n        bookkeeper,\n        instructionKey: createListingInstructionKey,\n      },\n      { programs, payer }\n    );\n  const { receipt, sellerTradeState } = listingBuilder.getContext();\n\n  const listing: Listing = {\n    model: 'listing',\n    lazy: false,\n    auctionHouse,\n    asset,\n    tradeStateAddress: sellerTradeState,\n    bookkeeperAddress: toPublicKey(bookkeeper),\n    sellerAddress: toPublicKey(seller),\n    receiptAddress: receipt,\n    purchaseReceiptAddress: null,\n    price,\n    tokens,\n    createdAt: now(),\n    canceledAt: null,\n  };\n\n  const saleBuilder: TransactionBuilder<ExecuteSaleBuilderContext> = metaplex\n    .auctionHouse()\n    .builders()\n    .executeSale(\n      {\n        auctionHouse,\n        auctioneerAuthority,\n        bid,\n        listing,\n        printReceipt,\n        bookkeeper,\n        instructionKey: executeSaleInstructionKey,\n      },\n      { programs, payer }\n    );\n  const { receipt: receiptAddress } = saleBuilder.getContext();\n\n  const buyerTokenAccount = metaplex.tokens().pdas().associatedTokenAccount({\n    mint: asset.address,\n    owner: buyerAddress,\n    programs,\n  });\n  const purchasedAsset = {\n    ...asset,\n    token: {\n      ...asset.token,\n      address: buyerTokenAccount,\n      ownerAddress: buyerAddress,\n    },\n  };\n\n  const purchase: Purchase = {\n    auctionHouse,\n    model: 'purchase',\n    lazy: false,\n    asset: purchasedAsset,\n    buyerAddress,\n    sellerAddress: toPublicKey(seller),\n    bookkeeperAddress: toPublicKey(bookkeeper),\n    receiptAddress,\n    price: bid.price,\n    tokens,\n    createdAt: now(),\n  };\n\n  return TransactionBuilder.make<DirectSellBuilderContext>()\n    .setFeePayer(payer)\n    .setContext({\n      listing,\n      purchase,\n    })\n    .add(listingBuilder)\n    .add(saleBuilder);\n};\n"],"names":["Key","directSellOperation","useOperation","directSellOperationHandler","handle","operation","metaplex","scope","builder","directSellBuilder","input","throwIfCanceled","sendAndConfirm","confirmOptions","params","options","programs","payer","rpc","getDefaultFeePayer","auctionHouse","auctioneerAuthority","bid","seller","identity","authority","authorityAddress","bookkeeper","createListingInstructionKey","executeSaleInstructionKey","hasAuctioneer","tokens","price","buyerAddress","printReceipt","Boolean","receiptAddress","AuctioneerAuthorityRequiredError","asset","isPrivateBid","token","sellerToken","listingBuilder","builders","list","mintAccount","mint","address","tokenAccount","instructionKey","receipt","sellerTradeState","getContext","listing","model","lazy","tradeStateAddress","bookkeeperAddress","toPublicKey","sellerAddress","purchaseReceiptAddress","createdAt","now","canceledAt","saleBuilder","executeSale","buyerTokenAccount","pdas","associatedTokenAccount","owner","purchasedAsset","ownerAddress","purchase","TransactionBuilder","make","setFeePayer","setContext","add"],"mappings":"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"}