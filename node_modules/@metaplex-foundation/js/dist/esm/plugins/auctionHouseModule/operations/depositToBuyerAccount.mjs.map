{"version":3,"file":"depositToBuyerAccount.mjs","sources":["../../../../../src/plugins/auctionHouseModule/operations/depositToBuyerAccount.ts"],"sourcesContent":["import {\n  createAuctioneerDepositInstruction,\n  createDepositInstruction,\n  DepositInstructionAccounts,\n} from '@metaplex-foundation/mpl-auction-house';\nimport { SendAndConfirmTransactionResponse } from '../../rpcModule';\nimport { AuctioneerAuthorityRequiredError } from '../errors';\nimport { AuctionHouse } from '../models';\nimport { TransactionBuilder, TransactionBuilderOptions } from '@/utils';\nimport {\n  isSigner,\n  Operation,\n  OperationHandler,\n  OperationScope,\n  Signer,\n  SolAmount,\n  SplTokenAmount,\n  toPublicKey,\n  useOperation,\n} from '@/types';\nimport type { Metaplex } from '@/Metaplex';\n\n// -----------------\n// Operation\n// -----------------\n\nconst Key = 'DepositToBuyerAccountOperation' as const;\n\n/**\n * Adds funds to the user's buyer escrow account for the given auction house.\n *\n * ```ts\n * await metaplex\n *   .auctionHouse()\n *   .depositToBuyerAccount({ auctionHouse, buyer, amount };\n * ```\n *\n * @group Operations\n * @category Constructors\n */\nexport const depositToBuyerAccountOperation =\n  useOperation<DepositToBuyerAccountOperation>(Key);\n\n/**\n * @group Operations\n * @category Types\n */\nexport type DepositToBuyerAccountOperation = Operation<\n  typeof Key,\n  DepositToBuyerAccountInput,\n  DepositToBuyerAccountOutput\n>;\n\n/**\n * @group Operations\n * @category Inputs\n */\nexport type DepositToBuyerAccountInput = {\n  /**\n   * The Auction House in which escrow buyer deposits funds.\n   * We only need a subset of the `AuctionHouse` model but we\n   * need enough information regarding its settings to know how\n   * to deposit funds.\n   *\n   * This includes, its address, authority address, treasury mint, etc.\n   */\n  auctionHouse: Pick<\n    AuctionHouse,\n    | 'address'\n    | 'authorityAddress'\n    | 'hasAuctioneer'\n    | 'isNative'\n    | 'treasuryMint'\n    | 'feeAccountAddress'\n  >;\n\n  /**\n   * The buyer who deposits funds.\n   * This expects a Signer.\n   *\n   * @defaultValue `metaplex.identity()`\n   */\n  buyer?: Signer;\n\n  /**\n   * The Auctioneer authority key.\n   * It is required when Auction House has Auctioneer enabled.\n   *\n   * @defaultValue Defaults to not being used.\n   */\n  auctioneerAuthority?: Signer;\n\n  /**\n   * Amount of funds to deposit.\n   * This can either be in SOL or in the SPL token used by the Auction House as a currency.\n   */\n  amount: SolAmount | SplTokenAmount;\n};\n\n/**\n * @group Operations\n * @category Outputs\n */\nexport type DepositToBuyerAccountOutput = {\n  /** The blockchain response from sending and confirming the transaction. */\n  response: SendAndConfirmTransactionResponse;\n};\n\n/**\n * @group Operations\n * @category Handlers\n */\nexport const depositToBuyerAccountOperationHandler: OperationHandler<DepositToBuyerAccountOperation> =\n  {\n    handle: async (\n      operation: DepositToBuyerAccountOperation,\n      metaplex: Metaplex,\n      scope: OperationScope\n    ) =>\n      depositToBuyerAccountBuilder(\n        metaplex,\n        operation.input,\n        scope\n      ).sendAndConfirm(metaplex, scope.confirmOptions),\n  };\n\n// -----------------\n// Builder\n// -----------------\n\n/**\n * @group Transaction Builders\n * @category Inputs\n */\nexport type DepositToBuyerAccountBuilderParams = Omit<\n  DepositToBuyerAccountInput,\n  'confirmOptions'\n> & {\n  instructionKey?: string;\n};\n\n/**\n * @group Transaction Builders\n * @category Contexts\n */\nexport type DepositToBuyerAccountBuilderContext = Omit<\n  DepositToBuyerAccountOutput,\n  'response'\n>;\n\n/**\n * Adds funds to the user's buyer escrow account for the given auction house.\n *\n * ```ts\n * const transactionBuilder = metaplex\n *   .auctionHouse()\n *   .builders()\n *   .depositToBuyerAccount({ auctionHouse, buyer, amount });\n * ```\n *\n * @group Transaction Builders\n * @category Constructors\n */\nexport const depositToBuyerAccountBuilder = (\n  metaplex: Metaplex,\n  params: DepositToBuyerAccountBuilderParams,\n  options: TransactionBuilderOptions = {}\n): TransactionBuilder<DepositToBuyerAccountBuilderContext> => {\n  // Data.\n  const { programs, payer = metaplex.rpc().getDefaultFeePayer() } = options;\n  const {\n    auctionHouse,\n    auctioneerAuthority,\n    amount,\n    instructionKey,\n    buyer = metaplex.identity(),\n  } = params;\n\n  if (auctionHouse.hasAuctioneer && !auctioneerAuthority) {\n    throw new AuctioneerAuthorityRequiredError();\n  }\n\n  // Accounts.\n  const paymentAccount = auctionHouse.isNative\n    ? toPublicKey(buyer)\n    : metaplex\n        .tokens()\n        .pdas()\n        .associatedTokenAccount({\n          mint: auctionHouse.treasuryMint.address,\n          owner: toPublicKey(buyer),\n          programs,\n        });\n  const escrowPayment = metaplex\n    .auctionHouse()\n    .pdas()\n    .buyerEscrow({\n      auctionHouse: auctionHouse.address,\n      buyer: toPublicKey(buyer),\n      programs,\n    });\n\n  const accounts: DepositInstructionAccounts = {\n    wallet: toPublicKey(buyer),\n    paymentAccount,\n    transferAuthority: toPublicKey(buyer),\n    escrowPaymentAccount: escrowPayment,\n    treasuryMint: auctionHouse.treasuryMint.address,\n    authority: auctionHouse.authorityAddress,\n    auctionHouse: auctionHouse.address,\n    auctionHouseFeeAccount: auctionHouse.feeAccountAddress,\n  };\n\n  // Args.\n  const args = {\n    escrowPaymentBump: escrowPayment.bump,\n    amount: amount.basisPoints,\n  };\n\n  // Deposit Instruction.\n  let depositInstruction = createDepositInstruction(accounts, args);\n  if (auctioneerAuthority) {\n    const ahAuctioneerPda = metaplex.auctionHouse().pdas().auctioneer({\n      auctionHouse: auctionHouse.address,\n      auctioneerAuthority: auctioneerAuthority.publicKey,\n      programs,\n    });\n\n    const accountsWithAuctioneer = {\n      ...accounts,\n      auctioneerAuthority: auctioneerAuthority.publicKey,\n      ahAuctioneerPda,\n    };\n\n    depositInstruction = createAuctioneerDepositInstruction(\n      { ...accountsWithAuctioneer },\n      args\n    );\n  }\n\n  // Signers.\n  const depositSigners = [buyer, auctioneerAuthority].filter(isSigner);\n\n  return (\n    TransactionBuilder.make()\n      .setFeePayer(payer)\n      // Deposit.\n      .add({\n        instruction: depositInstruction,\n        signers: depositSigners,\n        key: instructionKey ?? 'depositToBuyerAccount',\n      })\n  );\n};\n"],"names":["Key","depositToBuyerAccountOperation","useOperation","depositToBuyerAccountOperationHandler","handle","operation","metaplex","scope","depositToBuyerAccountBuilder","input","sendAndConfirm","confirmOptions","params","options","programs","payer","rpc","getDefaultFeePayer","auctionHouse","auctioneerAuthority","amount","instructionKey","buyer","identity","hasAuctioneer","AuctioneerAuthorityRequiredError","paymentAccount","isNative","toPublicKey","tokens","pdas","associatedTokenAccount","mint","treasuryMint","address","owner","escrowPayment","buyerEscrow","accounts","wallet","transferAuthority","escrowPaymentAccount","authority","authorityAddress","auctionHouseFeeAccount","feeAccountAddress","args","escrowPaymentBump","bump","basisPoints","depositInstruction","createDepositInstruction","ahAuctioneerPda","auctioneer","publicKey","accountsWithAuctioneer","createAuctioneerDepositInstruction","depositSigners","filter","isSigner","TransactionBuilder","make","setFeePayer","add","instruction","signers","key"],"mappings":"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"}