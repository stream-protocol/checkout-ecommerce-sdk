{"version":3,"file":"createBid.mjs","sources":["../../../../../src/plugins/auctionHouseModule/operations/createBid.ts"],"sourcesContent":["import {\n  BuyInstructionAccounts,\n  createAuctioneerBuyInstruction,\n  createAuctioneerPublicBuyInstruction,\n  createBuyInstruction,\n  createPrintBidReceiptInstruction,\n  createPublicBuyInstruction,\n} from '@metaplex-foundation/mpl-auction-house';\nimport { PublicKey, SYSVAR_INSTRUCTIONS_PUBKEY } from '@solana/web3.js';\nimport { SendAndConfirmTransactionResponse } from '../../rpcModule';\nimport { AuctioneerAuthorityRequiredError } from '../errors';\nimport { AuctionHouse, Bid, LazyBid } from '../models';\nimport { Option, TransactionBuilder, TransactionBuilderOptions } from '@/utils';\nimport {\n  amount,\n  isSigner,\n  lamports,\n  makeConfirmOptionsFinalizedOnMainnet,\n  now,\n  Operation,\n  OperationHandler,\n  OperationScope,\n  Pda,\n  Signer,\n  SolAmount,\n  SplTokenAmount,\n  token,\n  toPublicKey,\n  useOperation,\n} from '@/types';\nimport type { Metaplex } from '@/Metaplex';\n\n// -----------------\n// Operation\n// -----------------\n\nconst Key = 'CreateBidOperation' as const;\n\n/**\n * Creates a bid on a given asset.\n *\n * You can post a public bid on a non-listed NFT by skipping seller and tokenAccount properties.\n * Public bids are specific to the token itself and not to any specific auction.\n * This means that a bid can stay active beyond the end of an auction\n * and be resolved if it meets the criteria for subsequent auctions of that token.\n *\n *\n * ```ts\n * await metaplex\n *   .auctionHouse()\n *   .createBid({ auctionHouse, mintAccount, seller };\n * ```\n *\n * @group Operations\n * @category Constructors\n */\nexport const createBidOperation = useOperation<CreateBidOperation>(Key);\n\n/**\n * @group Operations\n * @category Types\n */\nexport type CreateBidOperation = Operation<\n  typeof Key,\n  CreateBidInput,\n  CreateBidOutput\n>;\n\n/**\n * @group Operations\n * @category Inputs\n */\nexport type CreateBidInput = {\n  /** The Auction House in which to create a Bid. */\n  auctionHouse: AuctionHouse;\n\n  /**\n   * Creator of a bid.\n   *\n   * @defaultValue `metaplex.identity()`\n   */\n  buyer?: Signer;\n\n  /**\n   * The Auction House authority.\n   * If this is Signer the transaction fee\n   * will be paid from the Auction House Fee Account\n   *\n   * @defaultValue `auctionHouse.authority`\n   */\n  authority?: PublicKey | Signer;\n\n  /**\n   * The Auctioneer authority key.\n   * It is required when Auction House has Auctioneer enabled.\n   *\n   * @defaultValue No default value.\n   */\n  auctioneerAuthority?: Signer;\n\n  /**\n   * The mint account to create a bid for.\n   * This is used to find the metadata.\n   */\n  mintAccount: PublicKey;\n\n  /**\n   * The account address that holds the asset a bid created is for.\n   * If this or tokenAccount isn't provided, then the bid will be public.\n   *\n   * @defaultValue No default value.\n   */\n  seller?: Option<PublicKey>;\n\n  /**\n   * The token account address that's associated to the asset a bid created is for.\n   * If this or seller isn't provided, then the bid will be public.\n   *\n   * @defaultValue No default value.\n   */\n  tokenAccount?: Option<PublicKey>;\n\n  /**\n   * The buyer's price.\n   *\n   * @defaultValue 0 SOLs or tokens.\n   */\n  price?: SolAmount | SplTokenAmount;\n\n  /**\n   * The number of tokens to bid for.\n   * For an NFT bid it must be 1 token.\n   *\n   * When a Fungible Asset is put on sale.\n   * The buyer can then create a buy order of said assets that is\n   * less than the token_size of the sell order.\n   *\n   * @defaultValue 1 token.\n   */\n  tokens?: SplTokenAmount;\n\n  /**\n   * Prints the bid receipt.\n   * The receipt holds information about the bid,\n   * So it's important to print it if you want to use the `Bid` model\n   *\n   * The receipt printing is skipped for the Auctioneer Auction House\n   * Since it currently doesn't support it.\n   *\n   * @defaultValue `true`\n   */\n  printReceipt?: boolean;\n\n  /**\n   * The address of the bookkeeper wallet responsible for the receipt.\n   *\n   * @defaultValue `metaplex.identity()`\n   */\n  bookkeeper?: Signer;\n};\n\n/**\n * @group Operations\n * @category Outputs\n */\nexport type CreateBidOutput = {\n  /** Buyer trade state account PDA encoding the bid order. */\n  buyerTradeState: Pda;\n\n  /** The asset's token account address in case the bid is private. */\n  tokenAccount: Option<PublicKey>;\n\n  /** The asset's metadata PDA. */\n  metadata: Pda;\n\n  /** The potential buyer of the asset. */\n  buyer: PublicKey;\n\n  /** The PDA of the receipt account in case it was printed. */\n  receipt: Option<Pda>;\n\n  /** The address of the bookkeeper wallet responsible for the receipt. */\n  bookkeeper: Option<PublicKey>;\n\n  /** The buyer's price. */\n  price: SolAmount | SplTokenAmount;\n\n  /** The number of tokens to bid for. */\n  tokens: SplTokenAmount;\n\n  /** A model that keeps information about the Bid. */\n  bid: Bid;\n\n  /** The blockchain response from sending and confirming the transaction. */\n  response: SendAndConfirmTransactionResponse;\n};\n\n/**\n * @group Operations\n * @category Handlers\n */\nexport const createBidOperationHandler: OperationHandler<CreateBidOperation> = {\n  async handle(\n    operation: CreateBidOperation,\n    metaplex: Metaplex,\n    scope: OperationScope\n  ): Promise<CreateBidOutput> {\n    const { auctionHouse } = operation.input;\n\n    const builder = await createBidBuilder(metaplex, operation.input, scope);\n    const confirmOptions = makeConfirmOptionsFinalizedOnMainnet(\n      metaplex,\n      scope.confirmOptions\n    );\n    const output = await builder.sendAndConfirm(metaplex, confirmOptions);\n    scope.throwIfCanceled();\n\n    if (output.receipt) {\n      const bid = await metaplex\n        .auctionHouse()\n        .findBidByReceipt(\n          { auctionHouse, receiptAddress: output.receipt },\n          scope\n        );\n\n      return { bid, ...output };\n    }\n\n    scope.throwIfCanceled();\n    const lazyBid: LazyBid = {\n      model: 'bid',\n      lazy: true,\n      auctionHouse,\n      tradeStateAddress: output.buyerTradeState,\n      bookkeeperAddress: output.bookkeeper,\n      tokenAddress: output.tokenAccount,\n      buyerAddress: output.buyer,\n      metadataAddress: output.metadata,\n      receiptAddress: output.receipt,\n      purchaseReceiptAddress: null,\n      isPublic: Boolean(output.tokenAccount),\n      price: output.price,\n      tokens: output.tokens.basisPoints,\n      createdAt: now(),\n      canceledAt: null,\n    };\n\n    return {\n      bid: await metaplex.auctionHouse().loadBid({ lazyBid }, scope),\n      ...output,\n    };\n  },\n};\n\n// -----------------\n// Builder\n// -----------------\n\n/**\n * @group Transaction Builders\n * @category Inputs\n */\nexport type CreateBidBuilderParams = Omit<CreateBidInput, 'confirmOptions'> & {\n  instructionKey?: string;\n};\n\n/**\n * @group Transaction Builders\n * @category Contexts\n */\nexport type CreateBidBuilderContext = Omit<CreateBidOutput, 'response' | 'bid'>;\n\n/**\n * Creates a bid on a given asset.\n *\n * You can post a public bid on a non-listed NFT by skipping seller and tokenAccount properties.\n * Public bids are specific to the token itself and not to any specific auction.\n * This means that a bid can stay active beyond the end of an auction\n * and be resolved if it meets the criteria for subsequent auctions of that token.\n *\n *\n * ```ts\n * const transactionBuilder = metaplex\n *   .auctionHouse()\n *   .builders()\n *   .createBid({ auctionHouse, mintAccount, seller })\n * ```\n *\n * @group Transaction Builders\n * @category Constructors\n */\nexport const createBidBuilder = async (\n  metaplex: Metaplex,\n  params: CreateBidBuilderParams,\n  options: TransactionBuilderOptions = {}\n): Promise<TransactionBuilder<CreateBidBuilderContext>> => {\n  // Data.\n  const { programs, payer = metaplex.rpc().getDefaultFeePayer() } = options;\n  const { auctionHouse } = params;\n  const tokens = params.tokens ?? token(1);\n  const priceBasisPoint = params.price?.basisPoints ?? 0;\n  const price = auctionHouse.isNative\n    ? lamports(priceBasisPoint)\n    : amount(priceBasisPoint, auctionHouse.treasuryMint.currency);\n\n  if (auctionHouse.hasAuctioneer && !params.auctioneerAuthority) {\n    throw new AuctioneerAuthorityRequiredError();\n  }\n\n  // Accounts.\n  const buyer = params.buyer ?? (metaplex.identity() as Signer);\n  const authority = params.authority ?? auctionHouse.authorityAddress;\n  const metadata = metaplex.nfts().pdas().metadata({\n    mint: params.mintAccount,\n    programs,\n  });\n  const paymentAccount = auctionHouse.isNative\n    ? toPublicKey(buyer)\n    : metaplex\n        .tokens()\n        .pdas()\n        .associatedTokenAccount({\n          mint: auctionHouse.treasuryMint.address,\n          owner: toPublicKey(buyer),\n          programs,\n        });\n  const escrowPayment = metaplex\n    .auctionHouse()\n    .pdas()\n    .buyerEscrow({\n      auctionHouse: auctionHouse.address,\n      buyer: toPublicKey(buyer),\n      programs,\n    });\n  const tokenAccount =\n    params.tokenAccount ??\n    (params.seller\n      ? metaplex.tokens().pdas().associatedTokenAccount({\n          mint: params.mintAccount,\n          owner: params.seller,\n          programs,\n        })\n      : null);\n  const buyerTokenAccount = metaplex\n    .tokens()\n    .pdas()\n    .associatedTokenAccount({\n      mint: params.mintAccount,\n      owner: toPublicKey(buyer),\n      programs,\n    });\n\n  const buyerTradeState = metaplex\n    .auctionHouse()\n    .pdas()\n    .tradeState({\n      auctionHouse: auctionHouse.address,\n      wallet: toPublicKey(buyer),\n      treasuryMint: auctionHouse.treasuryMint.address,\n      tokenMint: params.mintAccount,\n      price: price.basisPoints,\n      tokenSize: tokens.basisPoints,\n      tokenAccount,\n      programs,\n    });\n\n  const accounts: Omit<BuyInstructionAccounts, 'tokenAccount'> = {\n    wallet: toPublicKey(buyer),\n    paymentAccount,\n    transferAuthority: toPublicKey(buyer),\n    treasuryMint: auctionHouse.treasuryMint.address,\n    metadata,\n    escrowPaymentAccount: escrowPayment,\n    authority: toPublicKey(authority),\n    auctionHouse: auctionHouse.address,\n    auctionHouseFeeAccount: auctionHouse.feeAccountAddress,\n    buyerTradeState,\n  };\n\n  // Args.\n  const args = {\n    tradeStateBump: buyerTradeState.bump,\n    escrowPaymentBump: escrowPayment.bump,\n    buyerPrice: price.basisPoints,\n    tokenSize: tokens.basisPoints,\n  };\n\n  // Sell Instruction.\n  let buyInstruction = tokenAccount\n    ? createBuyInstruction({ ...accounts, tokenAccount }, args)\n    : createPublicBuyInstruction(\n        { ...accounts, tokenAccount: buyerTokenAccount },\n        args\n      );\n\n  if (params.auctioneerAuthority) {\n    const ahAuctioneerPda = metaplex.auctionHouse().pdas().auctioneer({\n      auctionHouse: auctionHouse.address,\n      auctioneerAuthority: params.auctioneerAuthority.publicKey,\n      programs,\n    });\n\n    const accountsWithAuctioneer = {\n      ...accounts,\n      auctioneerAuthority: params.auctioneerAuthority.publicKey,\n      ahAuctioneerPda,\n    };\n\n    buyInstruction = tokenAccount\n      ? createAuctioneerBuyInstruction(\n          { ...accountsWithAuctioneer, tokenAccount },\n          args\n        )\n      : createAuctioneerPublicBuyInstruction(\n          {\n            ...accountsWithAuctioneer,\n            tokenAccount: buyerTokenAccount,\n          },\n          args\n        );\n  }\n\n  // Signers.\n  const buySigners = [buyer, authority, params.auctioneerAuthority].filter(\n    isSigner\n  );\n\n  // Update the accounts to be signers since it's not covered properly by MPL due to its dynamic nature.\n  buySigners.forEach((signer) => {\n    const signerKeyIndex = buyInstruction.keys.findIndex(({ pubkey }) =>\n      pubkey.equals(signer.publicKey)\n    );\n\n    buyInstruction.keys[signerKeyIndex].isSigner = true;\n  });\n\n  // Receipt.\n  // Since createPrintBidReceiptInstruction can't deserialize createAuctioneerBuyInstruction due to a bug\n  // Don't print Auctioneer Bid receipt for the time being.\n  const shouldPrintReceipt =\n    (params.printReceipt ?? true) && !params.auctioneerAuthority;\n  const bookkeeper = params.bookkeeper ?? metaplex.identity();\n  const receipt = metaplex.auctionHouse().pdas().bidReceipt({\n    tradeState: buyerTradeState,\n    programs,\n  });\n\n  const builder = TransactionBuilder.make<CreateBidBuilderContext>()\n    .setFeePayer(payer)\n    .setContext({\n      buyerTradeState,\n      tokenAccount,\n      metadata,\n      buyer: toPublicKey(buyer),\n      receipt: shouldPrintReceipt ? receipt : null,\n      bookkeeper: shouldPrintReceipt ? bookkeeper.publicKey : null,\n      price,\n      tokens,\n    });\n\n  // Create a TA for public bid if it doesn't exist\n  if (!tokenAccount) {\n    const account = await metaplex.rpc().getAccount(buyerTokenAccount);\n    if (!account.exists) {\n      builder.add(\n        await metaplex\n          .tokens()\n          .builders()\n          .createToken({\n            mint: params.mintAccount,\n            owner: toPublicKey(buyer),\n          })\n      );\n    }\n  }\n\n  return (\n    builder\n      // Create bid.\n      .add({\n        instruction: buyInstruction,\n        signers: buySigners,\n        key: 'buy',\n      })\n\n      // Print the Bid Receipt.\n      .when(shouldPrintReceipt, (builder) =>\n        builder.add({\n          instruction: createPrintBidReceiptInstruction(\n            {\n              receipt,\n              bookkeeper: bookkeeper.publicKey,\n              instruction: SYSVAR_INSTRUCTIONS_PUBKEY,\n            },\n            { receiptBump: receipt.bump }\n          ),\n          signers: [bookkeeper],\n          key: 'printBidReceipt',\n        })\n      )\n  );\n};\n"],"names":["Key","createBidOperation","useOperation","createBidOperationHandler","handle","operation","metaplex","scope","auctionHouse","input","builder","createBidBuilder","confirmOptions","makeConfirmOptionsFinalizedOnMainnet","output","sendAndConfirm","throwIfCanceled","receipt","bid","findBidByReceipt","receiptAddress","lazyBid","model","lazy","tradeStateAddress","buyerTradeState","bookkeeperAddress","bookkeeper","tokenAddress","tokenAccount","buyerAddress","buyer","metadataAddress","metadata","purchaseReceiptAddress","isPublic","Boolean","price","tokens","basisPoints","createdAt","now","canceledAt","loadBid","params","options","programs","payer","rpc","getDefaultFeePayer","token","priceBasisPoint","isNative","lamports","amount","treasuryMint","currency","hasAuctioneer","auctioneerAuthority","AuctioneerAuthorityRequiredError","identity","authority","authorityAddress","nfts","pdas","mint","mintAccount","paymentAccount","toPublicKey","associatedTokenAccount","address","owner","escrowPayment","buyerEscrow","seller","buyerTokenAccount","tradeState","wallet","tokenMint","tokenSize","accounts","transferAuthority","escrowPaymentAccount","auctionHouseFeeAccount","feeAccountAddress","args","tradeStateBump","bump","escrowPaymentBump","buyerPrice","buyInstruction","createBuyInstruction","createPublicBuyInstruction","ahAuctioneerPda","auctioneer","publicKey","accountsWithAuctioneer","createAuctioneerBuyInstruction","createAuctioneerPublicBuyInstruction","buySigners","filter","isSigner","forEach","signer","signerKeyIndex","keys","findIndex","pubkey","equals","shouldPrintReceipt","printReceipt","bidReceipt","TransactionBuilder","make","setFeePayer","setContext","account","getAccount","exists","add","builders","createToken","instruction","signers","key","when","createPrintBidReceiptInstruction","SYSVAR_INSTRUCTIONS_PUBKEY","receiptBump"],"mappings":"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"}