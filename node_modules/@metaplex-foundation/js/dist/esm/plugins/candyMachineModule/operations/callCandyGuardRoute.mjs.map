{"version":3,"file":"callCandyGuardRoute.mjs","sources":["../../../../../src/plugins/candyMachineModule/operations/callCandyGuardRoute.ts"],"sourcesContent":["import { createRouteInstruction } from '@metaplex-foundation/mpl-candy-guard';\nimport * as beet from '@metaplex-foundation/beet';\nimport { SendAndConfirmTransactionResponse } from '../../rpcModule';\nimport {\n  CandyGuardsRouteSettings,\n  CandyGuardsSettings,\n  DefaultCandyGuardRouteSettings,\n  DefaultCandyGuardSettings,\n} from '../guards';\nimport { CandyMachine } from '../models';\nimport { CandyGuardRequiredOnCandyMachineError } from '../errors';\nimport { Option, TransactionBuilder, TransactionBuilderOptions } from '@/utils';\nimport { Operation, OperationHandler, OperationScope, Signer } from '@/types';\nimport { Metaplex } from '@/Metaplex';\n\n// -----------------\n// Operation\n// -----------------\n\nconst Key = 'CallCandyGuardRouteOperation' as const;\n\n/**\n * Calls the special \"route\" instruction on a specific guard.\n *\n * This allows guards to provide additional features such as creating\n * PDAs that verify a payer before the mint instruction is executed or\n * freezing and thawing minted NFTs.\n *\n * The \"route\" instruction must select a specific guard on a specific group\n * (if groups are enabled) since it is possible for the same type of guard\n * to have different settings based on its group.\n *\n * Additionally, it is possible for a guard to support multiple \"paths\" within\n * their \"route\" instruction. The route settings of the guard will usually use\n * the `path` property to distinguish them.\n *\n * ```ts\n * const { nft } = await metaplex\n *   .candyMachines()\n *   .callGuardRoute({\n *     candyMachine,\n *     guard: 'allowList',\n *     settings: {\n *       path: 'proof',\n *       merkleProof: getMerkleProof(data, leaf)\n *     },\n *   };\n * ```\n *\n * @group Operations\n * @category Constructors\n */\nexport const callCandyGuardRouteOperation = _callCandyGuardRouteOperation;\n// eslint-disable-next-line @typescript-eslint/naming-convention\nfunction _callCandyGuardRouteOperation<\n  Guard extends keyof RouteSettings & string,\n  Settings extends CandyGuardsSettings = DefaultCandyGuardSettings,\n  RouteSettings extends CandyGuardsRouteSettings = DefaultCandyGuardRouteSettings\n>(\n  input: CallCandyGuardRouteInput<Guard, Settings, RouteSettings>\n): CallCandyGuardRouteOperation<Guard, Settings, RouteSettings> {\n  return { key: Key, input };\n}\n_callCandyGuardRouteOperation.key = Key;\n\n/**\n * @group Operations\n * @category Types\n */\nexport type CallCandyGuardRouteOperation<\n  Guard extends keyof RouteSettings & string,\n  Settings extends CandyGuardsSettings = DefaultCandyGuardSettings,\n  RouteSettings extends CandyGuardsRouteSettings = DefaultCandyGuardRouteSettings\n> = Operation<\n  typeof Key,\n  CallCandyGuardRouteInput<Guard, Settings, RouteSettings>,\n  CallCandyGuardRouteOutput\n>;\n\n/**\n * @group Operations\n * @category Inputs\n */\nexport type CallCandyGuardRouteInput<\n  Guard extends keyof RouteSettings & string,\n  Settings extends CandyGuardsSettings = DefaultCandyGuardSettings,\n  RouteSettings extends CandyGuardsRouteSettings = DefaultCandyGuardRouteSettings\n> = {\n  /**\n   * The Candy Machine containing the guard we are interested in.\n   * We only need a subset of the `CandyMachine` model but we\n   * need enough information regarding its settings to know how\n   * to execute the route instruction on the guard.\n   *\n   * This includes its address and the Candy Guard account associated with it.\n   */\n  candyMachine: Pick<CandyMachine<Settings>, 'address' | 'candyGuard'>;\n\n  /**\n   * The guard to select on the Candy Machine.\n   *\n   * If the Candy Machine uses groups of guards, the `group` property\n   * must also be provided so we known which specific guard to select.\n   */\n  guard: Guard;\n\n  /**\n   * The route settings of the selected guard.\n   *\n   * These will depend on the type of guard selected but they will\n   * usually include a `path` property to distinguish between the\n   * different paths available within their \"route\" instruction.\n   */\n  settings: RouteSettings[Guard];\n\n  /**\n   * The label of the group to mint from.\n   *\n   * If groups are configured on the Candy Machine,\n   * you must specify a group label to mint from.\n   *\n   * When set to `null` it will mint using the default\n   * guards, provided no groups are configured.\n   *\n   * @defaultValue `null`\n   */\n  group?: Option<string>;\n};\n\n/**\n * @group Operations\n * @category Outputs\n */\nexport type CallCandyGuardRouteOutput = {\n  /** The blockchain response from sending and confirming the transaction. */\n  response: SendAndConfirmTransactionResponse;\n};\n\n/**\n * @group Operations\n * @category Handlers\n */\nexport const callCandyGuardRouteOperationHandler: OperationHandler<\n  CallCandyGuardRouteOperation<any>\n> = {\n  async handle<\n    Guard extends keyof RouteSettings & string,\n    Settings extends CandyGuardsSettings = DefaultCandyGuardSettings,\n    RouteSettings extends CandyGuardsRouteSettings = DefaultCandyGuardRouteSettings\n  >(\n    operation: CallCandyGuardRouteOperation<Guard, Settings, RouteSettings>,\n    metaplex: Metaplex,\n    scope: OperationScope\n  ): Promise<CallCandyGuardRouteOutput> {\n    const builder = callCandyGuardRouteBuilder<Guard, Settings, RouteSettings>(\n      metaplex,\n      operation.input,\n      scope\n    );\n\n    return builder.sendAndConfirm(metaplex, scope.confirmOptions);\n  },\n};\n\n// -----------------\n// Builder\n// -----------------\n\n/**\n * @group Transaction Builders\n * @category Inputs\n */\nexport type CallCandyGuardRouteBuilderParams<\n  Guard extends keyof RouteSettings & string,\n  Settings extends CandyGuardsSettings = DefaultCandyGuardSettings,\n  RouteSettings extends CandyGuardsRouteSettings = DefaultCandyGuardRouteSettings\n> = Omit<\n  CallCandyGuardRouteInput<Guard, Settings, RouteSettings>,\n  'confirmOptions'\n> & {\n  /** A key to distinguish the instruction that mints from the Candy Machine. */\n  instructionKey?: string;\n};\n\n/**\n * Calls the special \"route\" instruction on a specific guard.\n *\n * This allows guards to provide additional features such as creating\n * PDAs that verify a payer before the mint instruction is executed or\n * freezing and thawing minted NFTs.\n *\n * The \"route\" instruction must select a specific guard on a specific group\n * (if groups are enabled) since it is possible for the same type of guard\n * to have different settings based on its group.\n *\n * Additionally, it is possible for a guard to support multiple \"paths\" within\n * their \"route\" instruction. The route settings of the guard will usually use\n * the `path` property to distinguish them.\n *\n * ```ts\n * const transactionBuilder = await metaplex\n *   .candyMachines()\n *   .builders()\n *   .callGuardRoute({\n *     candyMachine,\n *     guard: 'allowList',\n *     settings: {\n *       path: 'proof',\n *       merkleProof: getMerkleProof(data, leaf)\n *     },\n *   });\n * ```\n *\n * @group Transaction Builders\n * @category Constructors\n */\nexport const callCandyGuardRouteBuilder = <\n  Guard extends keyof RouteSettings & string,\n  Settings extends CandyGuardsSettings = DefaultCandyGuardSettings,\n  RouteSettings extends CandyGuardsRouteSettings = DefaultCandyGuardRouteSettings\n>(\n  metaplex: Metaplex,\n  params: CallCandyGuardRouteBuilderParams<Guard, Settings, RouteSettings>,\n  options: TransactionBuilderOptions = {}\n): TransactionBuilder => {\n  const { programs, payer = metaplex.rpc().getDefaultFeePayer() } = options;\n  const { candyMachine, guard, settings, group = null } = params;\n\n  if (!candyMachine.candyGuard) {\n    throw new CandyGuardRequiredOnCandyMachineError();\n  }\n\n  // Route instruction.\n  const parsedRouteSettings = metaplex\n    .candyMachines()\n    .guards()\n    .parseRouteSettings(\n      candyMachine.address,\n      candyMachine.candyGuard,\n      payer,\n      guard,\n      settings,\n      group,\n      programs\n    );\n\n  const routeSigners: Signer[] = [payer, ...parsedRouteSettings.signers];\n  const routeInstruction = createRouteInstruction(\n    {\n      candyGuard: candyMachine.candyGuard.address,\n      candyMachine: candyMachine.address,\n      payer: payer.publicKey,\n    },\n    {\n      args: {\n        // \"GuardType\" is an enum for default guards only and will assert this\n        // whereas we want to allow custom guards, so we need to pass anything\n        // here to create the instruction and override this data afterwards.\n        guard: 0,\n        data: parsedRouteSettings.arguments,\n      },\n      label: group,\n    },\n    metaplex.programs().getCandyGuard(programs).address\n  );\n  routeInstruction.keys.push(...parsedRouteSettings.accountMetas);\n\n  // As promised, we override the guard index here.\n  const availableGuards = metaplex\n    .candyMachines()\n    .guards()\n    .forCandyGuardProgram(programs);\n  const guardIndex = availableGuards.findIndex((g) => g.name === guard);\n  beet.u8.write(routeInstruction.data, 8, guardIndex);\n\n  return (\n    TransactionBuilder.make()\n      .setFeePayer(payer)\n\n      // Route instruction.\n      .add({\n        instruction: routeInstruction,\n        signers: routeSigners,\n        key: params.instructionKey ?? 'callGuardRoute',\n      })\n  );\n};\n"],"names":["Key","callCandyGuardRouteOperation","_callCandyGuardRouteOperation","input","key","callCandyGuardRouteOperationHandler","handle","operation","metaplex","scope","builder","callCandyGuardRouteBuilder","sendAndConfirm","confirmOptions","params","options","programs","payer","rpc","getDefaultFeePayer","candyMachine","guard","settings","group","candyGuard","CandyGuardRequiredOnCandyMachineError","parsedRouteSettings","candyMachines","guards","parseRouteSettings","address","routeSigners","signers","routeInstruction","createRouteInstruction","publicKey","args","data","arguments","label","getCandyGuard","keys","push","accountMetas","availableGuards","forCandyGuardProgram","guardIndex","findIndex","g","name","beet","u8","write","TransactionBuilder","make","setFeePayer","add","instruction","instructionKey"],"mappings":"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"}