{"version":3,"file":"createCandyGuard.mjs","sources":["../../../../../src/plugins/candyMachineModule/operations/createCandyGuard.ts"],"sourcesContent":["import { createInitializeInstruction } from '@metaplex-foundation/mpl-candy-guard';\nimport { Keypair, PublicKey } from '@solana/web3.js';\nimport { SendAndConfirmTransactionResponse } from '../../rpcModule';\nimport { CandyGuardsSettings, DefaultCandyGuardSettings } from '../guards';\nimport { CandyGuard } from '../models/CandyGuard';\nimport { TransactionBuilder, TransactionBuilderOptions } from '@/utils';\nimport {\n  makeConfirmOptionsFinalizedOnMainnet,\n  Operation,\n  OperationHandler,\n  OperationScope,\n  Pda,\n  Signer,\n} from '@/types';\nimport { Metaplex } from '@/Metaplex';\n\n// -----------------\n// Operation\n// -----------------\n\nconst Key = 'CreateCandyGuardOperation' as const;\n\n/**\n * Creates a new Candy Guard account with the provided settings.\n *\n * ```ts\n * const { candyGuard } = await metaplex\n *   .candyMachines()\n *   .createCandyGuard({\n *     guards: {\n *       startDate: { date: toDateTime('2022-09-05T20:00:00.000Z') },\n *       solPayment: { amount: sol(1.5), },\n *       botTax: { lamports: sol(0.01), lastInstruction: true },\n *     },\n *   };\n * ```\n *\n * @group Operations\n * @category Constructors\n */\nexport const createCandyGuardOperation = _createCandyGuardOperation;\n// eslint-disable-next-line @typescript-eslint/naming-convention\nfunction _createCandyGuardOperation<\n  T extends CandyGuardsSettings = DefaultCandyGuardSettings\n>(input: CreateCandyGuardInput<T>): CreateCandyGuardOperation<T> {\n  return { key: Key, input };\n}\n_createCandyGuardOperation.key = Key;\n\n/**\n * @group Operations\n * @category Types\n */\nexport type CreateCandyGuardOperation<\n  T extends CandyGuardsSettings = DefaultCandyGuardSettings\n> = Operation<typeof Key, CreateCandyGuardInput<T>, CreateCandyGuardOutput<T>>;\n\n/**\n * @group Operations\n * @category Inputs\n */\nexport type CreateCandyGuardInput<\n  T extends CandyGuardsSettings = DefaultCandyGuardSettings\n> = {\n  /**\n   * The \"base\" address of the Candy Guard to create as a Signer.\n   *\n   * This address will be deterministically derived to obtain the real\n   * address of the Candy Guard account. It expects a brand new Keypair\n   * such that its derived address has no associated account.\n   *\n   * @defaultValue `Keypair.generate()`\n   */\n  base?: Signer;\n\n  /**\n   * The authority that will be allowed to update the Candy Guard.\n   *\n   * @defaultValue `metaplex.identity().publicKey`\n   */\n  authority?: PublicKey;\n\n  /**\n   * The settings of all guards we wish to activate.\n   *\n   * Any guard not provided or set to `null` will be disabled.\n   */\n  guards: Partial<T>;\n\n  /**\n   * This parameter allows us to create multiple minting groups that have their\n   * own set of requirements â€” i.e. guards.\n   *\n   * When groups are provided, the `guards` parameter becomes a set of default\n   * guards that will be applied to all groups. If a specific group enables\n   * a guard that is also present in the default guards, the group's guard\n   * will override the default guard.\n   *\n   * For each group, any guard not provided or set to `null` will be disabled.\n   *\n   * @defaultValue `[]`\n   */\n  groups?: { label: string; guards: Partial<T> }[];\n};\n\n/**\n * @group Operations\n * @category Outputs\n */\nexport type CreateCandyGuardOutput<\n  T extends CandyGuardsSettings = DefaultCandyGuardSettings\n> = {\n  /** The blockchain response from sending and confirming the transaction. */\n  response: SendAndConfirmTransactionResponse;\n\n  /** The created Candy Guard. */\n  candyGuard: CandyGuard<T>;\n\n  /** The base address of the Candy Guard's account as a Signer. */\n  base: Signer;\n\n  /** The address of the created Candy Guard. */\n  candyGuardAddress: Pda;\n};\n\n/**\n * @group Operations\n * @category Handlers\n */\nexport const createCandyGuardOperationHandler: OperationHandler<CreateCandyGuardOperation> =\n  {\n    async handle<T extends CandyGuardsSettings = DefaultCandyGuardSettings>(\n      operation: CreateCandyGuardOperation<T>,\n      metaplex: Metaplex,\n      scope: OperationScope\n    ): Promise<CreateCandyGuardOutput<T>> {\n      const builder = createCandyGuardBuilder<T>(\n        metaplex,\n        operation.input,\n        scope\n      );\n\n      const confirmOptions = makeConfirmOptionsFinalizedOnMainnet(\n        metaplex,\n        scope.confirmOptions\n      );\n      const output = await builder.sendAndConfirm(metaplex, confirmOptions);\n      scope.throwIfCanceled();\n\n      const candyGuard = await metaplex\n        .candyMachines()\n        .findCandyGuardByBaseAddress<T>(\n          { address: output.base.publicKey },\n          scope\n        );\n\n      return { ...output, candyGuard };\n    },\n  };\n\n// -----------------\n// Builder\n// -----------------\n\n/**\n * @group Transaction Builders\n * @category Inputs\n */\nexport type CreateCandyGuardBuilderParams<\n  T extends CandyGuardsSettings = DefaultCandyGuardSettings\n> = Omit<CreateCandyGuardInput<T>, 'confirmOptions'> & {\n  /** A key to distinguish the instruction that creates and initializes the Candy Guard account. */\n  createCandyGuardInstructionKey?: string;\n};\n\n/**\n * @group Transaction Builders\n * @category Contexts\n */\nexport type CreateCandyGuardBuilderContext = Omit<\n  CreateCandyGuardOutput,\n  'response' | 'candyGuard'\n>;\n\n/**\n * Creates a new Candy Guard account with the provided settings.\n *\n * ```ts\n * const transactionBuilder = await metaplex\n *   .candyMachines()\n *   .builders()\n *   .createCandyGuard({\n *     guards: {\n *       startDate: { date: toDateTime('2022-09-05T20:00:00.000Z') },\n *       solPayment: { amount: sol(1.5), },\n *       botTax: { lamports: sol(0.01), lastInstruction: true },\n *     },\n *   });\n * ```\n *\n * @group Transaction Builders\n * @category Constructors\n */\nexport const createCandyGuardBuilder = <\n  T extends CandyGuardsSettings = DefaultCandyGuardSettings\n>(\n  metaplex: Metaplex,\n  params: CreateCandyGuardBuilderParams<T>,\n  options: TransactionBuilderOptions = {}\n): TransactionBuilder<CreateCandyGuardBuilderContext> => {\n  const { programs, payer = metaplex.rpc().getDefaultFeePayer() } = options;\n  const base = params.base ?? Keypair.generate();\n  const authority = params.authority ?? metaplex.identity().publicKey;\n  const candyGuardProgram = metaplex.programs().getCandyGuard(programs);\n  const candyGuard = metaplex.candyMachines().pdas().candyGuard({\n    base: base.publicKey,\n    programs,\n  });\n\n  const serializedSettings = metaplex\n    .candyMachines()\n    .guards()\n    .serializeSettings<T>(params.guards, params.groups ?? [], programs);\n\n  return (\n    TransactionBuilder.make<CreateCandyGuardBuilderContext>()\n      .setFeePayer(payer)\n      .setContext({ base, candyGuardAddress: candyGuard })\n\n      // Create and initialize the candy guard account.\n      .add({\n        instruction: createInitializeInstruction(\n          {\n            candyGuard,\n            base: base.publicKey,\n            authority,\n            payer: payer.publicKey,\n          },\n          { data: serializedSettings },\n          candyGuardProgram.address\n        ),\n        signers: [base, payer],\n        key: params.createCandyGuardInstructionKey ?? 'createCandyGuard',\n      })\n  );\n};\n"],"names":["Key","createCandyGuardOperation","_createCandyGuardOperation","input","key","createCandyGuardOperationHandler","handle","operation","metaplex","scope","builder","createCandyGuardBuilder","confirmOptions","makeConfirmOptionsFinalizedOnMainnet","output","sendAndConfirm","throwIfCanceled","candyGuard","candyMachines","findCandyGuardByBaseAddress","address","base","publicKey","params","options","programs","payer","rpc","getDefaultFeePayer","Keypair","generate","authority","identity","candyGuardProgram","getCandyGuard","pdas","serializedSettings","guards","serializeSettings","groups","TransactionBuilder","make","setFeePayer","setContext","candyGuardAddress","add","instruction","createInitializeInstruction","data","signers","createCandyGuardInstructionKey"],"mappings":";;;;;AAgBA;AACA;AACA;AAEA,MAAMA,GAAG,GAAG,2BAAZ,CAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACaC,MAAAA,yBAAyB,GAAGC;;AAEzC,SAASA,0BAAT,CAEEC,KAFF,EAEiE;EAC/D,OAAO;AAAEC,IAAAA,GAAG,EAAEJ,GAAP;AAAYG,IAAAA,KAAAA;GAAnB,CAAA;AACD,CAAA;;AACDD,0BAA0B,CAACE,GAA3B,GAAiCJ,GAAjC,CAAA;AAEA;AACA;AACA;AACA;;AAyEA;AACA;AACA;AACA;AACO,MAAMK,gCAA6E,GACxF;AACE,EAAA,MAAMC,MAAN,CACEC,SADF,EAEEC,QAFF,EAGEC,KAHF,EAIsC;IACpC,MAAMC,OAAO,GAAGC,uBAAuB,CACrCH,QADqC,EAErCD,SAAS,CAACJ,KAF2B,EAGrCM,KAHqC,CAAvC,CAAA;IAMA,MAAMG,cAAc,GAAGC,oCAAoC,CACzDL,QADyD,EAEzDC,KAAK,CAACG,cAFmD,CAA3D,CAAA;IAIA,MAAME,MAAM,GAAG,MAAMJ,OAAO,CAACK,cAAR,CAAuBP,QAAvB,EAAiCI,cAAjC,CAArB,CAAA;AACAH,IAAAA,KAAK,CAACO,eAAN,EAAA,CAAA;IAEA,MAAMC,UAAU,GAAG,MAAMT,QAAQ,CAC9BU,aADsB,EAAA,CAEtBC,2BAFsB,CAGrB;AAAEC,MAAAA,OAAO,EAAEN,MAAM,CAACO,IAAP,CAAYC,SAAAA;KAHF,EAIrBb,KAJqB,CAAzB,CAAA;IAOA,OAAO,EAAE,GAAGK,MAAL;AAAaG,MAAAA,UAAAA;KAApB,CAAA;AACD,GAAA;;AA3BH;AA+BF;AACA;;AAEA;AACA;AACA;AACA;;AAiBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAMN,uBAAuB,GAAG,CAGrCH,QAHqC,EAIrCe,MAJqC,EAKrCC,OAAkC,GAAG,EALA,KAMkB;EACvD,MAAM;IAAEC,QAAF;AAAYC,IAAAA,KAAK,GAAGlB,QAAQ,CAACmB,GAAT,GAAeC,kBAAf,EAAA;AAApB,GAAA,GAA4DJ,OAAlE,CAAA;EACA,MAAMH,IAAI,GAAGE,MAAM,CAACF,IAAP,IAAeQ,OAAO,CAACC,QAAR,EAA5B,CAAA;EACA,MAAMC,SAAS,GAAGR,MAAM,CAACQ,SAAP,IAAoBvB,QAAQ,CAACwB,QAAT,EAAA,CAAoBV,SAA1D,CAAA;EACA,MAAMW,iBAAiB,GAAGzB,QAAQ,CAACiB,QAAT,EAAoBS,CAAAA,aAApB,CAAkCT,QAAlC,CAA1B,CAAA;EACA,MAAMR,UAAU,GAAGT,QAAQ,CAACU,aAAT,EAAyBiB,CAAAA,IAAzB,EAAgClB,CAAAA,UAAhC,CAA2C;IAC5DI,IAAI,EAAEA,IAAI,CAACC,SADiD;AAE5DG,IAAAA,QAAAA;AAF4D,GAA3C,CAAnB,CAAA;EAKA,MAAMW,kBAAkB,GAAG5B,QAAQ,CAChCU,aADwB,EAExBmB,CAAAA,MAFwB,GAGxBC,iBAHwB,CAGHf,MAAM,CAACc,MAHJ,EAGYd,MAAM,CAACgB,MAAP,IAAiB,EAH7B,EAGiCd,QAHjC,CAA3B,CAAA;EAKA,OACEe,kBAAkB,CAACC,IAAnB,EAAA,CACGC,WADH,CACehB,KADf,CAEGiB,CAAAA,UAFH,CAEc;IAAEtB,IAAF;AAAQuB,IAAAA,iBAAiB,EAAE3B,UAAAA;AAA3B,GAFd,CAIE;AAJF,GAKG4B,GALH,CAKO;IACHC,WAAW,EAAEC,2BAA2B,CACtC;MACE9B,UADF;MAEEI,IAAI,EAAEA,IAAI,CAACC,SAFb;MAGES,SAHF;MAIEL,KAAK,EAAEA,KAAK,CAACJ,SAAAA;AAJf,KADsC,EAOtC;AAAE0B,MAAAA,IAAI,EAAEZ,kBAAAA;AAAR,KAPsC,EAQtCH,iBAAiB,CAACb,OARoB,CADrC;AAWH6B,IAAAA,OAAO,EAAE,CAAC5B,IAAD,EAAOK,KAAP,CAXN;AAYHtB,IAAAA,GAAG,EAAEmB,MAAM,CAAC2B,8BAAP,IAAyC,kBAAA;AAZ3C,GALP,CADF,CAAA;AAqBD;;;;"}